"""
Security Analysis Vulnerability Tests

Test Coverage:
- Severity enum with ordering
- Severity comparison operators
- CVSS score mapping
- Edge cases
"""

import pytest

from codegraph_analysis.security_analysis.domain.models.vulnerability import Severity


class TestSeverity:
    """Severity enum tests"""

    def test_all_severities_defined(self):
        """All severity levels exist"""
        assert Severity.CRITICAL.value == "critical"
        assert Severity.HIGH.value == "high"
        assert Severity.MEDIUM.value == "medium"
        assert Severity.LOW.value == "low"
        assert Severity.INFO.value == "info"

    def test_severity_ordering(self):
        """Severity ordering: CRITICAL > HIGH > MEDIUM > LOW > INFO"""
        assert Severity.CRITICAL > Severity.HIGH
        assert Severity.HIGH > Severity.MEDIUM
        assert Severity.MEDIUM > Severity.LOW
        assert Severity.LOW > Severity.INFO


class TestSeverityComparison:
    """Severity comparison operator tests"""

    def test_less_than(self):
        """Less than comparison"""
        assert Severity.INFO < Severity.LOW
        assert Severity.LOW < Severity.MEDIUM
        assert Severity.MEDIUM < Severity.HIGH
        assert Severity.HIGH < Severity.CRITICAL

    def test_less_than_or_equal(self):
        """Less than or equal comparison"""
        assert Severity.INFO <= Severity.INFO
        assert Severity.INFO <= Severity.LOW

    def test_greater_than(self):
        """Greater than comparison"""
        assert Severity.CRITICAL > Severity.HIGH
        assert Severity.HIGH > Severity.MEDIUM

    def test_greater_than_or_equal(self):
        """Greater than or equal comparison"""
        assert Severity.CRITICAL >= Severity.CRITICAL
        assert Severity.CRITICAL >= Severity.HIGH

    def test_equality(self):
        """Equality comparison"""
        assert Severity.HIGH == Severity.HIGH
        assert Severity.CRITICAL != Severity.HIGH


class TestSeverityMethods:
    """Severity method tests"""

    def test_get_emoji(self):
        """Get emoji for severity"""
        assert Severity.CRITICAL.get_emoji() == "ðŸ”´"
        assert Severity.HIGH.get_emoji() == "ðŸŸ "
        assert Severity.MEDIUM.get_emoji() == "ðŸŸ¡"
        assert Severity.LOW.get_emoji() == "ðŸŸ¢"
        assert Severity.INFO.get_emoji() == "ðŸ”µ"

    def test_to_cvss_score(self):
        """Convert to CVSS score"""
        # CRITICAL: 9.0-10.0
        assert 9.0 <= Severity.CRITICAL.to_cvss_score() <= 10.0
        # HIGH: 7.0-8.9
        assert 7.0 <= Severity.HIGH.to_cvss_score() < 9.0
        # MEDIUM: 4.0-6.9
        assert 4.0 <= Severity.MEDIUM.to_cvss_score() < 7.0
        # LOW: 0.1-3.9
        assert 0.1 <= Severity.LOW.to_cvss_score() < 4.0
        # INFO: 0.0
        assert Severity.INFO.to_cvss_score() == 0.0


class TestSeveritySorting:
    """Severity sorting tests"""

    def test_sort_severities(self):
        """Sort severities correctly"""
        severities = [
            Severity.LOW,
            Severity.CRITICAL,
            Severity.MEDIUM,
            Severity.INFO,
            Severity.HIGH,
        ]
        sorted_severities = sorted(severities)
        assert sorted_severities[0] == Severity.INFO
        assert sorted_severities[-1] == Severity.CRITICAL

    def test_max_severity(self):
        """Get max severity"""
        severities = [Severity.LOW, Severity.HIGH, Severity.MEDIUM]
        max_severity = max(severities)
        assert max_severity == Severity.HIGH

    def test_min_severity(self):
        """Get min severity"""
        severities = [Severity.LOW, Severity.HIGH, Severity.MEDIUM]
        min_severity = min(severities)
        assert min_severity == Severity.LOW


class TestEdgeCases:
    """Edge cases"""

    def test_compare_with_invalid_type(self):
        """Comparing with invalid type raises TypeError"""
        with pytest.raises(TypeError):
            Severity.HIGH < "high"

        with pytest.raises(TypeError):
            Severity.HIGH <= 5

        with pytest.raises(TypeError):
            Severity.HIGH > None

    def test_all_severities_have_emoji(self):
        """All severities have emoji"""
        for severity in Severity:
            emoji = severity.get_emoji()
            assert emoji is not None
            assert len(emoji) > 0

    def test_all_severities_have_cvss(self):
        """All severities have CVSS score"""
        for severity in Severity:
            score = severity.to_cvss_score()
            assert 0.0 <= score <= 10.0

    def test_cvss_score_ordering_matches_severity(self):
        """CVSS scores follow severity ordering"""
        assert Severity.CRITICAL.to_cvss_score() > Severity.HIGH.to_cvss_score()
        assert Severity.HIGH.to_cvss_score() > Severity.MEDIUM.to_cvss_score()
        assert Severity.MEDIUM.to_cvss_score() > Severity.LOW.to_cvss_score()
        assert Severity.LOW.to_cvss_score() > Severity.INFO.to_cvss_score()
