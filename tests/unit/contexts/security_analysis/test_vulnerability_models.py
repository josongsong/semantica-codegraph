"""
Vulnerability Models Unit Tests

Tests for Severity, CWE, Location, Evidence, Vulnerability, ScanResult.
"""

from datetime import datetime

import pytest

from codegraph_analysis.security_analysis.domain.models.vulnerability import (
    _SEVERITY_EMOJI,
    _SEVERITY_ORDER,
    CWE,
    Evidence,
    Location,
    ScanResult,
    Severity,
    Vulnerability,
)


class TestSeverity:
    """Severity enum tests"""

    # === Basic Comparison ===

    def test_severity_ordering_critical_highest(self):
        """CRITICAL should be the highest severity"""
        assert Severity.CRITICAL > Severity.HIGH
        assert Severity.CRITICAL > Severity.MEDIUM
        assert Severity.CRITICAL > Severity.LOW
        assert Severity.CRITICAL > Severity.INFO

    def test_severity_ordering_info_lowest(self):
        """INFO should be the lowest severity"""
        assert Severity.INFO < Severity.LOW
        assert Severity.INFO < Severity.MEDIUM
        assert Severity.INFO < Severity.HIGH
        assert Severity.INFO < Severity.CRITICAL

    def test_severity_ordering_all(self):
        """Full ordering test"""
        assert Severity.CRITICAL > Severity.HIGH > Severity.MEDIUM > Severity.LOW > Severity.INFO

    def test_severity_equality(self):
        """Same severity should be equal"""
        assert Severity.HIGH == Severity.HIGH
        assert not (Severity.HIGH < Severity.HIGH)
        assert not (Severity.HIGH > Severity.HIGH)

    def test_severity_le_ge(self):
        """Less-than-or-equal and greater-than-or-equal"""
        assert Severity.HIGH >= Severity.HIGH
        assert Severity.HIGH <= Severity.HIGH
        assert Severity.CRITICAL >= Severity.HIGH
        assert Severity.LOW <= Severity.MEDIUM

    # === Emoji ===

    def test_severity_emoji_critical(self):
        assert Severity.CRITICAL.get_emoji() == "ðŸ”´"

    def test_severity_emoji_high(self):
        assert Severity.HIGH.get_emoji() == "ðŸŸ "

    def test_severity_emoji_medium(self):
        assert Severity.MEDIUM.get_emoji() == "ðŸŸ¡"

    def test_severity_emoji_low(self):
        assert Severity.LOW.get_emoji() == "ðŸŸ¢"

    def test_severity_emoji_info(self):
        assert Severity.INFO.get_emoji() == "ðŸ”µ"

    # === CVSS Score ===

    def test_severity_cvss_critical(self):
        assert Severity.CRITICAL.to_cvss_score() == 9.5

    def test_severity_cvss_high(self):
        assert Severity.HIGH.to_cvss_score() == 7.5

    def test_severity_cvss_medium(self):
        assert Severity.MEDIUM.to_cvss_score() == 5.5

    def test_severity_cvss_low(self):
        assert Severity.LOW.to_cvss_score() == 2.5

    def test_severity_cvss_info(self):
        assert Severity.INFO.to_cvss_score() == 0.0

    # === String Value ===

    def test_severity_is_string(self):
        """Severity inherits from str"""
        assert isinstance(Severity.CRITICAL, str)
        assert Severity.CRITICAL.value == "critical"

    # === Type Safety ===

    def test_severity_compare_with_string_raises_typeerror(self):
        """Comparing with string should raise TypeError"""
        with pytest.raises(TypeError, match="not supported between 'Severity' and 'str'"):
            Severity.HIGH > "high"

    def test_severity_compare_with_int_raises_typeerror(self):
        """Comparing with int should raise TypeError"""
        with pytest.raises(TypeError, match="not supported between 'Severity' and 'int'"):
            Severity.HIGH > 3

    def test_severity_compare_with_none_raises_typeerror(self):
        """Comparing with None should raise TypeError"""
        with pytest.raises(TypeError, match="not supported between 'Severity' and 'NoneType'"):
            Severity.HIGH > None

    def test_severity_le_with_string_raises_typeerror(self):
        """<= with string should raise TypeError"""
        with pytest.raises(TypeError):
            Severity.HIGH <= "high"

    def test_severity_ge_with_string_raises_typeerror(self):
        """>= with string should raise TypeError"""
        with pytest.raises(TypeError):
            Severity.HIGH >= "high"

    # === Edge Cases ===

    def test_severity_sorting(self):
        """Sorting list of severities"""
        severities = [Severity.LOW, Severity.CRITICAL, Severity.MEDIUM, Severity.HIGH, Severity.INFO]
        sorted_asc = sorted(severities)
        assert sorted_asc == [Severity.INFO, Severity.LOW, Severity.MEDIUM, Severity.HIGH, Severity.CRITICAL]

        sorted_desc = sorted(severities, reverse=True)
        assert sorted_desc == [Severity.CRITICAL, Severity.HIGH, Severity.MEDIUM, Severity.LOW, Severity.INFO]

    def test_severity_as_dict_key(self):
        """Severity can be used as dict key"""
        d = {Severity.HIGH: "high_value", Severity.LOW: "low_value"}
        assert d[Severity.HIGH] == "high_value"
        assert Severity.HIGH in d
        assert Severity.CRITICAL not in d

    def test_severity_in_set(self):
        """Severity can be used in set"""
        s = {Severity.HIGH, Severity.LOW, Severity.HIGH}  # duplicate
        assert len(s) == 2
        assert Severity.HIGH in s


class TestCWE:
    """CWE enum tests"""

    def test_cwe_value(self):
        assert CWE.CWE_89.value == "CWE-89"
        assert CWE.CWE_78.value == "CWE-78"

    def test_cwe_name_sql_injection(self):
        assert CWE.CWE_89.get_name() == "SQL Injection"

    def test_cwe_name_command_injection(self):
        assert CWE.CWE_78.get_name() == "OS Command Injection"

    def test_cwe_name_xss(self):
        assert CWE.CWE_79.get_name() == "Cross-site Scripting"

    def test_cwe_name_ssrf(self):
        assert CWE.CWE_918.get_name() == "Server-Side Request Forgery"


class TestLocation:
    """Location dataclass tests"""

    def test_location_basic(self):
        loc = Location(file_path="test.py", start_line=10, end_line=20)
        assert loc.file_path == "test.py"
        assert loc.start_line == 10
        assert loc.end_line == 20
        assert loc.start_column == 0
        assert loc.end_column == 0

    def test_location_with_columns(self):
        loc = Location(file_path="test.py", start_line=10, end_line=10, start_column=5, end_column=15)
        assert loc.start_column == 5
        assert loc.end_column == 15

    def test_location_repr(self):
        loc = Location(file_path="test.py", start_line=10, end_line=20)
        assert repr(loc) == "test.py:10-20"

    # Edge cases
    def test_location_single_line(self):
        loc = Location(file_path="a.py", start_line=1, end_line=1)
        assert loc.start_line == loc.end_line

    def test_location_empty_path(self):
        loc = Location(file_path="", start_line=0, end_line=0)
        assert loc.file_path == ""


class TestEvidence:
    """Evidence dataclass tests"""

    def test_evidence_basic(self):
        loc = Location("test.py", 10, 10)
        evidence = Evidence(
            location=loc,
            code_snippet="user_input = request.args.get('id')",
            description="Source of tainted data",
            node_type="source",
        )
        assert evidence.location == loc
        assert "request.args" in evidence.code_snippet
        assert evidence.node_type == "source"

    def test_evidence_default_values(self):
        loc = Location("test.py", 1, 1)
        evidence = Evidence(location=loc, code_snippet="x = 1", description="test")
        assert evidence.node_type == "unknown"
        assert evidence.metadata == {}


class TestVulnerability:
    """Vulnerability dataclass tests"""

    @pytest.fixture
    def sample_vulnerability(self):
        return Vulnerability(
            cwe=CWE.CWE_89,
            severity=Severity.CRITICAL,
            title="SQL Injection in login",
            description="User input flows to SQL query without sanitization",
            source_location=Location("app.py", 10, 10),
            sink_location=Location("app.py", 25, 25),
            recommendation="Use parameterized queries",
            confidence=0.95,
        )

    def test_vulnerability_basic(self, sample_vulnerability):
        assert sample_vulnerability.cwe == CWE.CWE_89
        assert sample_vulnerability.severity == Severity.CRITICAL
        assert sample_vulnerability.confidence == 0.95

    def test_vulnerability_repr(self, sample_vulnerability):
        repr_str = repr(sample_vulnerability)
        assert "CWE-89" in repr_str
        assert "critical" in repr_str

    def test_vulnerability_to_dict(self, sample_vulnerability):
        d = sample_vulnerability.to_dict()
        assert d["cwe"] == "CWE-89"
        assert d["cwe_name"] == "SQL Injection"
        assert d["severity"] == "critical"
        assert d["cvss_score"] == 9.5
        assert d["confidence"] == 0.95

    def test_vulnerability_get_severity_emoji(self, sample_vulnerability):
        assert sample_vulnerability.get_severity_emoji() == "ðŸ”´"

    def test_vulnerability_default_values(self):
        vuln = Vulnerability(
            cwe=CWE.CWE_79,
            severity=Severity.MEDIUM,
            title="XSS",
            description="",
            source_location=Location("a.py", 1, 1),
            sink_location=Location("a.py", 2, 2),
        )
        assert vuln.taint_path == []
        assert vuln.recommendation == ""
        assert vuln.references == []
        assert vuln.confidence == 1.0
        assert vuln.false_positive_risk == "low"
        assert vuln.metadata == {}

    def test_vulnerability_to_dict_empty_taint_path(self):
        """to_dict handles empty taint_path correctly"""
        vuln = Vulnerability(
            cwe=CWE.CWE_89,
            severity=Severity.HIGH,
            title="Test",
            description="",
            source_location=Location("a.py", 1, 1),
            sink_location=Location("a.py", 2, 2),
        )
        d = vuln.to_dict()
        assert d["taint_path_length"] == 0
        assert d["source"]["snippet"] == ""
        assert d["sink"]["snippet"] == ""

    def test_vulnerability_to_dict_with_taint_path(self):
        """to_dict includes taint_path info"""
        vuln = Vulnerability(
            cwe=CWE.CWE_89,
            severity=Severity.HIGH,
            title="Test",
            description="",
            source_location=Location("a.py", 1, 1),
            sink_location=Location("a.py", 5, 5),
            taint_path=[
                Evidence(Location("a.py", 1, 1), "source_code", "source", "source"),
                Evidence(Location("a.py", 3, 3), "middle_code", "propagation", "propagation"),
                Evidence(Location("a.py", 5, 5), "sink_code", "sink", "sink"),
            ],
        )
        d = vuln.to_dict()
        assert d["taint_path_length"] == 3
        assert d["source"]["snippet"] == "source_code"
        assert d["sink"]["snippet"] == "sink_code"


class TestScanResult:
    """ScanResult dataclass tests"""

    @pytest.fixture
    def sample_scan_result(self):
        vulns = [
            Vulnerability(
                cwe=CWE.CWE_89,
                severity=Severity.CRITICAL,
                title="SQLi",
                description="",
                source_location=Location("a.py", 1, 1),
                sink_location=Location("a.py", 2, 2),
            ),
            Vulnerability(
                cwe=CWE.CWE_89,
                severity=Severity.HIGH,
                title="SQLi 2",
                description="",
                source_location=Location("b.py", 1, 1),
                sink_location=Location("b.py", 2, 2),
            ),
            Vulnerability(
                cwe=CWE.CWE_79,
                severity=Severity.MEDIUM,
                title="XSS",
                description="",
                source_location=Location("c.py", 1, 1),
                sink_location=Location("c.py", 2, 2),
            ),
        ]
        return ScanResult(vulnerabilities=vulns, files_scanned=10, scan_duration_ms=1500)

    def test_scan_result_basic(self, sample_scan_result):
        assert len(sample_scan_result.vulnerabilities) == 3
        assert sample_scan_result.files_scanned == 10
        assert sample_scan_result.scan_duration_ms == 1500

    def test_get_by_severity(self, sample_scan_result):
        critical = sample_scan_result.get_by_severity(Severity.CRITICAL)
        assert len(critical) == 1
        assert critical[0].severity == Severity.CRITICAL

        high = sample_scan_result.get_by_severity(Severity.HIGH)
        assert len(high) == 1

        info = sample_scan_result.get_by_severity(Severity.INFO)
        assert len(info) == 0

    def test_get_by_cwe(self, sample_scan_result):
        sql_injection = sample_scan_result.get_by_cwe(CWE.CWE_89)
        assert len(sql_injection) == 2

        xss = sample_scan_result.get_by_cwe(CWE.CWE_79)
        assert len(xss) == 1

        ssrf = sample_scan_result.get_by_cwe(CWE.CWE_918)
        assert len(ssrf) == 0

    def test_get_summary(self, sample_scan_result):
        summary = sample_scan_result.get_summary()
        assert summary["total"] == 3
        assert summary["by_severity"]["critical"] == 1
        assert summary["by_severity"]["high"] == 1
        assert summary["by_severity"]["medium"] == 1
        assert summary["by_cwe"]["CWE-89"] == 2
        assert summary["by_cwe"]["CWE-79"] == 1
        assert summary["files_scanned"] == 10

    def test_empty_scan_result(self):
        result = ScanResult()
        assert len(result.vulnerabilities) == 0
        summary = result.get_summary()
        assert summary["total"] == 0
        assert summary["by_severity"] == {}


class TestModuleLevelConstants:
    """Test module-level constants work correctly"""

    def test_severity_order_dict(self):
        assert _SEVERITY_ORDER["critical"] == 5
        assert _SEVERITY_ORDER["info"] == 1

    def test_severity_emoji_dict(self):
        assert _SEVERITY_EMOJI["critical"] == "ðŸ”´"
        assert _SEVERITY_EMOJI["info"] == "ðŸ”µ"
