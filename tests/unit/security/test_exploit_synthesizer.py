"""
Unit Tests for ExploitTestSynthesizer (RFC-051 Phase 1.5)

Test Coverage:
- Playwright test code generation
- Context-aware payload generation
- Entry point detection
- Test case building

Author: Semantica Team
"""

import pytest

from codegraph_engine.code_foundation.domain.ports.template_ports import (
    EscapeMode,
    SlotContextKind,
    TemplateSlotContract,
)
from codegraph_engine.code_foundation.infrastructure.ir.models import Edge, EdgeKind, IRDocument, Node, NodeKind
from codegraph_engine.code_foundation.infrastructure.security.exploit_synthesizer import (
    ExploitTestSynthesizer,
    create_exploit_synthesizer,
)


# ============================================================
# Fixtures
# ============================================================


@pytest.fixture
def sample_xss_sink():
    """Sample XSS sink (dangerouslySetInnerHTML)"""
    return TemplateSlotContract(
        slot_id="slot:profile.jsx:42:30",
        host_node_id="elem:profile.jsx:42:10",
        expr_raw="{{__html: user.bio}}",
        expr_span=(1024, 1044),
        context_kind=SlotContextKind.RAW_HTML,
        escape_mode=EscapeMode.NONE,
        is_sink=True,
        name_hint="user.bio",
        framework="react",
    )


@pytest.fixture
def ir_doc_with_binding():
    """IRDocument with BINDS edge"""
    doc = IRDocument(repo_id="test", snapshot_id="2025-12-21")

    doc.nodes.extend(
        [
            Node(
                id="func:renderProfile",
                kind=NodeKind.FUNCTION,
                fqn="profile.renderProfile",
                name="renderProfile",
                file_path="profile.jsx",
                span=(10, 100),
                language="javascript",
            ),
            Node(
                id="var:user_bio",
                kind=NodeKind.VARIABLE,
                fqn="profile.renderProfile.user_bio",
                name="user_bio",
                file_path="profile.jsx",
                span=(20, 30),
                language="javascript",
                parent_id="func:renderProfile",
            ),
        ]
    )

    doc.edges.append(
        Edge(
            id="edge:binds:var→slot",
            kind=EdgeKind.BINDS,
            source_id="var:user_bio",
            target_id="slot:profile.jsx:42:30",
        )
    )

    doc.build_indexes()
    return doc


# ============================================================
# Basic Functionality Tests
# ============================================================


class TestExploitTestSynthesizer:
    """Test ExploitTestSynthesizer basic functionality"""

    def test_synthesize_xss_test_basic(self, sample_xss_sink, ir_doc_with_binding):
        """Generate Playwright test from XSS sink"""
        synthesizer = ExploitTestSynthesizer()

        test_code = synthesizer.synthesize_xss_test(sample_xss_sink, ir_doc_with_binding)

        # Verify test code structure
        assert "import { test, expect } from '@playwright/test'" in test_code
        assert "test(" in test_code
        assert "async ({ page })" in test_code
        assert "page.goto(" in test_code
        assert "page.fill(" in test_code
        assert "expect(content).not.toContain('<script>')" in test_code

    def test_reject_non_sink(self, ir_doc_with_binding):
        """Reject non-sink slots"""
        synthesizer = ExploitTestSynthesizer()

        safe_slot = TemplateSlotContract(
            slot_id="slot:test.jsx:1:1",
            host_node_id="elem:test.jsx:1:1",
            expr_raw="{safe}",
            expr_span=(0, 6),
            context_kind=SlotContextKind.HTML_TEXT,
            escape_mode=EscapeMode.AUTO,
            is_sink=False,  # Not a sink
        )

        with pytest.raises(ValueError, match="is not a sink"):
            synthesizer.synthesize_xss_test(safe_slot, ir_doc_with_binding)


# ============================================================
# Payload Generation Tests
# ============================================================


class TestPayloadGeneration:
    """Test context-aware payload generation"""

    @pytest.mark.parametrize(
        "context,expected_payload",
        [
            (SlotContextKind.RAW_HTML, '<script>alert("XSS")</script>'),
            (SlotContextKind.URL_ATTR, 'javascript:alert("XSS")'),
            (SlotContextKind.EVENT_HANDLER, 'alert("XSS")'),
            (SlotContextKind.HTML_ATTR, '"><script>alert("XSS")</script><"'),
        ],
    )
    def test_context_aware_payloads(self, context, expected_payload):
        """Payloads are context-specific"""
        synthesizer = ExploitTestSynthesizer()

        payload = synthesizer._generate_payload(context)

        assert payload == expected_payload

    def test_all_contexts_have_payloads(self):
        """All SlotContextKind have payload definitions"""
        synthesizer = ExploitTestSynthesizer()

        for context in SlotContextKind:
            payload = synthesizer._generate_payload(context)
            assert payload is not None
            assert len(payload) > 0


# ============================================================
# Entry Point Detection Tests
# ============================================================


class TestEntryPointDetection:
    """Test entry point detection"""

    def test_find_entry_point_with_binding(self, sample_xss_sink, ir_doc_with_binding):
        """Entry point found via BINDS edge"""
        synthesizer = ExploitTestSynthesizer()

        entry_point = synthesizer._find_entry_point(sample_xss_sink, ir_doc_with_binding)

        assert entry_point is not None
        assert entry_point.function_name == "renderProfile"
        assert entry_point.route == "/profile"
        assert entry_point.file_path == "profile.jsx"

    def test_find_entry_point_no_binding(self, sample_xss_sink):
        """Fallback entry point when no BINDS edge"""
        synthesizer = ExploitTestSynthesizer()

        empty_doc = IRDocument(repo_id="test", snapshot_id="2025-12-21")
        empty_doc.build_indexes()

        entry_point = synthesizer._find_entry_point(sample_xss_sink, empty_doc)

        # Should return fallback
        assert entry_point.function_name == "unknown"
        assert entry_point.route == "/"

    def test_route_guessing(self):
        """Route guessing from function name"""
        synthesizer = ExploitTestSynthesizer()

        test_cases = [
            ("renderProfile", "/profile"),
            ("UserDashboard", "/user"),
            ("showDashboard", "/dashboard"),
            ("unknownFunc", "/"),
        ]

        for func_name, expected_route in test_cases:
            node = Node(
                id="func:test",
                kind=NodeKind.FUNCTION,
                fqn="test.func",
                name=func_name,
                file_path="test.jsx",
                span=(0, 10),
                language="javascript",
            )
            route = synthesizer._guess_route(node)
            assert route == expected_route, f"{func_name} → {route} (expected: {expected_route})"


# ============================================================
# Code Generation Tests
# ============================================================


class TestCodeGeneration:
    """Test Playwright code generation"""

    def test_generated_code_is_valid_typescript(self, sample_xss_sink, ir_doc_with_binding):
        """Generated code has valid TypeScript syntax"""
        synthesizer = ExploitTestSynthesizer()

        test_code = synthesizer.synthesize_xss_test(sample_xss_sink, ir_doc_with_binding)

        # Basic syntax checks
        assert test_code.count("import") >= 1
        assert test_code.count("test(") == 1
        assert test_code.count("async") >= 1
        assert test_code.count("await") >= 3

        # No unbalanced braces
        assert test_code.count("{") == test_code.count("}")
        assert test_code.count("(") == test_code.count(")")

    def test_generated_code_includes_fix_suggestion(self, sample_xss_sink, ir_doc_with_binding):
        """Generated code includes fix suggestion"""
        synthesizer = ExploitTestSynthesizer()

        test_code = synthesizer.synthesize_xss_test(sample_xss_sink, ir_doc_with_binding)

        # Should include fix suggestion
        assert "Fix suggestion:" in test_code
        assert "DOMPurify" in test_code


# ============================================================
# Factory Function Tests
# ============================================================


class TestFactoryFunction:
    """Test create_exploit_synthesizer() factory"""

    def test_create_exploit_synthesizer(self):
        """Factory creates ExploitTestSynthesizer"""
        synthesizer = create_exploit_synthesizer()

        assert isinstance(synthesizer, ExploitTestSynthesizer)


if __name__ == "__main__":
    pytest.main([__file__, "-v", "--tb=short"])
