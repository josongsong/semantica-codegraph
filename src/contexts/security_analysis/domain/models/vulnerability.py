"""
Vulnerability models

Core domain models for security vulnerabilities.
"""

from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import List, Optional, Dict


class Severity(str, Enum):
    """
    Vulnerability severity levels

    Based on CVSS v3.1:
    - CRITICAL: 9.0-10.0
    - HIGH: 7.0-8.9
    - MEDIUM: 4.0-6.9
    - LOW: 0.1-3.9
    - INFO: 0.0
    """

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

    def __lt__(self, other):
        """Compare severities for sorting"""
        order = {
            Severity.CRITICAL: 5,
            Severity.HIGH: 4,
            Severity.MEDIUM: 3,
            Severity.LOW: 2,
            Severity.INFO: 1,
        }
        return order[self] < order[other]

    def to_cvss_score(self) -> float:
        """Convert to approximate CVSS score"""
        mapping = {
            Severity.CRITICAL: 9.5,
            Severity.HIGH: 7.5,
            Severity.MEDIUM: 5.5,
            Severity.LOW: 2.5,
            Severity.INFO: 0.0,
        }
        return mapping[self]


class CWE(str, Enum):
    """
    Common Weakness Enumeration

    Top security weaknesses from OWASP Top 10 and CWE Top 25.
    """

    # Injection
    CWE_89 = "CWE-89"  # SQL Injection
    CWE_78 = "CWE-78"  # OS Command Injection
    CWE_79 = "CWE-79"  # Cross-site Scripting (XSS)
    CWE_94 = "CWE-94"  # Code Injection
    CWE_95 = "CWE-95"  # Eval Injection
    CWE_643 = "CWE-643"  # XPath Injection
    CWE_90 = "CWE-90"  # LDAP Injection

    # Access Control
    CWE_22 = "CWE-22"  # Path Traversal
    CWE_639 = "CWE-639"  # Insecure Direct Object Reference (IDOR)
    CWE_284 = "CWE-284"  # Improper Access Control
    CWE_863 = "CWE-863"  # Incorrect Authorization

    # Cryptography
    CWE_327 = "CWE-327"  # Use of Broken/Risky Crypto
    CWE_798 = "CWE-798"  # Hardcoded Credentials
    CWE_330 = "CWE-330"  # Weak Random Number Generator
    CWE_338 = "CWE-338"  # Use of Cryptographically Weak PRNG

    # Deserialization
    CWE_502 = "CWE-502"  # Deserialization of Untrusted Data

    # SSRF
    CWE_918 = "CWE-918"  # Server-Side Request Forgery (SSRF)

    # Information Disclosure
    CWE_200 = "CWE-200"  # Information Exposure
    CWE_209 = "CWE-209"  # Information Exposure Through Error Message

    def get_name(self) -> str:
        """Get human-readable name"""
        names = {
            CWE.CWE_89: "SQL Injection",
            CWE.CWE_78: "OS Command Injection",
            CWE.CWE_79: "Cross-site Scripting",
            CWE.CWE_94: "Code Injection",
            CWE.CWE_95: "Eval Injection",
            CWE.CWE_643: "XPath Injection",
            CWE.CWE_90: "LDAP Injection",
            CWE.CWE_22: "Path Traversal",
            CWE.CWE_639: "Insecure Direct Object Reference",
            CWE.CWE_284: "Improper Access Control",
            CWE.CWE_863: "Incorrect Authorization",
            CWE.CWE_327: "Broken/Risky Cryptography",
            CWE.CWE_798: "Hardcoded Credentials",
            CWE.CWE_330: "Weak Random Number Generator",
            CWE.CWE_338: "Weak Pseudo-Random Number Generator",
            CWE.CWE_502: "Deserialization of Untrusted Data",
            CWE.CWE_918: "Server-Side Request Forgery",
            CWE.CWE_200: "Information Exposure",
            CWE.CWE_209: "Error Message Information Leak",
        }
        return names.get(self, self.value)


@dataclass
class Location:
    """
    Source code location

    Identifies where a vulnerability or evidence is located.
    """

    file_path: str
    """Absolute or relative file path"""

    start_line: int
    """Starting line number (1-based)"""

    end_line: int
    """Ending line number (1-based)"""

    start_column: int = 0
    """Starting column (0-based, optional)"""

    end_column: int = 0
    """Ending column (0-based, optional)"""

    def __repr__(self):
        return f"{self.file_path}:{self.start_line}-{self.end_line}"


@dataclass
class Evidence:
    """
    Evidence for a vulnerability

    Tracks the path from source to sink.
    """

    location: Location
    """Where this evidence is located"""

    code_snippet: str
    """Relevant code snippet"""

    description: str
    """What this evidence shows"""

    node_type: str = "unknown"
    """Type of node (source, sink, propagation, sanitizer)"""

    metadata: Dict = field(default_factory=dict)
    """Additional metadata"""


@dataclass
class Vulnerability:
    """
    Security vulnerability

    Represents a detected security issue with full context.
    """

    # Identity
    cwe: CWE
    """CWE classification"""

    severity: Severity
    """Severity level"""

    title: str
    """Short title (e.g., "SQL Injection in login function")"""

    description: str
    """Detailed description"""

    # Locations
    source_location: Location
    """Where the tainted data originates"""

    sink_location: Location
    """Where the vulnerability manifests"""

    # Evidence
    taint_path: List[Evidence] = field(default_factory=list)
    """Path from source to sink"""

    # Recommendations
    recommendation: str = ""
    """How to fix this vulnerability"""

    references: List[str] = field(default_factory=list)
    """External references (URLs, docs)"""

    # Metadata
    confidence: float = 1.0
    """Confidence score (0.0-1.0)"""

    false_positive_risk: str = "low"
    """Risk of false positive: low, medium, high"""

    discovered_at: datetime = field(default_factory=datetime.now)
    """When this was discovered"""

    metadata: Dict = field(default_factory=dict)
    """Additional metadata"""

    def __repr__(self):
        return f"Vulnerability({self.cwe.value}, {self.severity.value}, {self.sink_location})"

    def to_dict(self) -> dict:
        """Convert to dictionary for serialization"""
        return {
            "cwe": self.cwe.value,
            "cwe_name": self.cwe.get_name(),
            "severity": self.severity.value,
            "cvss_score": self.severity.to_cvss_score(),
            "title": self.title,
            "description": self.description,
            "source": {
                "file": self.source_location.file_path,
                "line": self.source_location.start_line,
                "snippet": self.taint_path[0].code_snippet if self.taint_path else "",
            },
            "sink": {
                "file": self.sink_location.file_path,
                "line": self.sink_location.start_line,
                "snippet": self.taint_path[-1].code_snippet if self.taint_path else "",
            },
            "taint_path_length": len(self.taint_path),
            "recommendation": self.recommendation,
            "confidence": self.confidence,
            "false_positive_risk": self.false_positive_risk,
            "discovered_at": self.discovered_at.isoformat(),
        }

    def get_severity_emoji(self) -> str:
        """Get emoji for severity"""
        emojis = {
            Severity.CRITICAL: "ðŸ”´",
            Severity.HIGH: "ðŸŸ ",
            Severity.MEDIUM: "ðŸŸ¡",
            Severity.LOW: "ðŸŸ¢",
            Severity.INFO: "ðŸ”µ",
        }
        return emojis.get(self.severity, "âšª")


@dataclass
class ScanResult:
    """
    Results from a security scan

    Aggregates all vulnerabilities found.
    """

    vulnerabilities: List[Vulnerability] = field(default_factory=list)
    """All vulnerabilities found"""

    files_scanned: int = 0
    """Number of files scanned"""

    scan_duration_ms: int = 0
    """Scan duration in milliseconds"""

    metadata: Dict = field(default_factory=dict)
    """Scan metadata (rules used, config, etc.)"""

    def get_by_severity(self, severity: Severity) -> List[Vulnerability]:
        """Get vulnerabilities by severity"""
        return [v for v in self.vulnerabilities if v.severity == severity]

    def get_by_cwe(self, cwe: CWE) -> List[Vulnerability]:
        """Get vulnerabilities by CWE"""
        return [v for v in self.vulnerabilities if v.cwe == cwe]

    def get_summary(self) -> dict:
        """Get summary statistics"""
        by_severity = {}
        for sev in Severity:
            count = len(self.get_by_severity(sev))
            if count > 0:
                by_severity[sev.value] = count

        by_cwe = {}
        for vuln in self.vulnerabilities:
            by_cwe[vuln.cwe.value] = by_cwe.get(vuln.cwe.value, 0) + 1

        return {
            "total": len(self.vulnerabilities),
            "by_severity": by_severity,
            "by_cwe": by_cwe,
            "files_scanned": self.files_scanned,
            "scan_duration_ms": self.scan_duration_ms,
        }
