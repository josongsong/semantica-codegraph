# Memory System

3-Tier ë©”ëª¨ë¦¬ ì•„í‚¤í…ì²˜ë¡œ ì—ì´ì „íŠ¸ê°€ ê³¼ê±° ê²½í—˜ì—ì„œ í•™ìŠµí•˜ê³  ì ì  ë˜‘ë˜‘í•´ì§€ë„ë¡ í•©ë‹ˆë‹¤.

## ğŸ“ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Memory System                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚ Working Memory â”‚  â† í˜„ì¬ ì„¸ì…˜ (íœ˜ë°œì„±)                       â”‚
â”‚  â”‚  (Short-term)  â”‚    - í˜„ì¬ íƒœìŠ¤í¬ ìƒíƒœ                       â”‚
â”‚  â”‚                â”‚    - ìµœê·¼ Nê°œ ìŠ¤í… ê²°ê³¼                     â”‚
â”‚  â”‚                â”‚    - í™œì„±í™”ëœ ì»¨í…ìŠ¤íŠ¸                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚          â”‚ consolidate                                           â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚Episodic Memory â”‚  â† ì„¸ì…˜/íƒœìŠ¤í¬ ë‹¨ìœ„ (ì˜êµ¬ ì €ì¥)             â”‚
â”‚  â”‚  (Mid-term)    â”‚    - ì™„ë£Œëœ íƒœìŠ¤í¬ ê¸°ë¡                     â”‚
â”‚  â”‚                â”‚    - ì„±ê³µ/ì‹¤íŒ¨ ì—í”¼ì†Œë“œ                     â”‚
â”‚  â”‚                â”‚    - ë¬¸ì œ-í•´ê²° í˜ì–´                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚          â”‚ extract patterns                                      â”‚
â”‚          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚Semantic Memory â”‚  â† ì¼ë°˜í™”ëœ ì§€ì‹ (ì˜êµ¬ ì €ì¥)                â”‚
â”‚  â”‚  (Long-term)   â”‚    - ì½”ë“œ íŒ¨í„´                              â”‚
â”‚  â”‚                â”‚    - í”„ë¡œì íŠ¸ ê·œì¹™                          â”‚
â”‚  â”‚                â”‚    - ë²„ê·¸ íŒ¨í„´ â†’ ì†”ë£¨ì…˜ ë§¤í•‘                â”‚
â”‚  â”‚                â”‚    - ì‚¬ìš©ì ì„ í˜¸ë„                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ êµ¬ì¡°

```
src/memory/
â”œâ”€â”€ __init__.py              # Package exports
â”œâ”€â”€ models.py                # ë°ì´í„° ëª¨ë¸ (Episode, BugPattern, etc.)
â”œâ”€â”€ working.py               # Working Memory Manager
â”œâ”€â”€ episodic.py              # Episodic Memory Manager
â”œâ”€â”€ semantic.py              # Semantic Memory Manager
â”œâ”€â”€ retrieval.py             # Memory Retrieval System (orchestrator)
â””â”€â”€ persistence/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ store.py             # Storage abstractions
```

## ğŸ“¦ ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### 1. Working Memory (ë‹¨ê¸° ê¸°ì–µ)

í˜„ì¬ ì„¸ì…˜ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

```python
from src.memory import WorkingMemoryManager

# ì„¸ì…˜ ì‹œì‘
working_memory = WorkingMemoryManager()
working_memory.init_task({
    "query": "Fix authentication bug",
    "type": "debug"
})

# ì‹¤í–‰ ì¶”ì 
working_memory.track_file("src/auth/login.py", modified=True)
working_memory.add_hypothesis(
    "Token validation fails due to timezone",
    confidence=0.8
)
working_memory.record_decision(
    description="Use UTC for all token operations",
    rationale="Timezone mismatch causing validation failures"
)

# ì„¸ì…˜ ì¢…ë£Œ ì‹œ consolidate
episode = working_memory.consolidate()
```

### 2. Episodic Memory (ì¤‘ê¸° ê¸°ì–µ)

ì™„ë£Œëœ ì—í”¼ì†Œë“œë¥¼ ì €ì¥í•˜ê³  ê²€ìƒ‰í•©ë‹ˆë‹¤.

```python
from src.memory import EpisodicMemoryManager, SimilarityQuery, TaskType

episodic = EpisodicMemoryManager()

# ì—í”¼ì†Œë“œ ì €ì¥
await episodic.store(episode)

# ìœ ì‚¬í•œ ì—í”¼ì†Œë“œ ê²€ìƒ‰
similar = await episodic.find_similar(
    SimilarityQuery(
        task_type=TaskType.DEBUG,
        files=["src/auth/login.py"],
        limit=5
    )
)

# ì—ëŸ¬ íŒ¨í„´ìœ¼ë¡œ ê²€ìƒ‰
error_episodes = await episodic.find_by_error_pattern(
    error_type="TokenValidationError"
)
```

### 3. Semantic Memory (ì¥ê¸° ê¸°ì–µ)

ì¼ë°˜í™”ëœ íŒ¨í„´ê³¼ ì§€ì‹ì„ í•™ìŠµí•©ë‹ˆë‹¤.

```python
from src.memory import SemanticMemoryManager

semantic = SemanticMemoryManager()

# ì—í”¼ì†Œë“œì—ì„œ í•™ìŠµ
await semantic.learn_from_episode(episode)

# ë²„ê·¸ íŒ¨í„´ ë§¤ì¹­
patterns = await semantic.match_bug_pattern(
    error_type="TokenValidationError",
    error_message="Token validation failed"
)

# í”„ë¡œì íŠ¸ ì§€ì‹ ì¡°íšŒ
knowledge = semantic.get_or_create_project_knowledge("my-project")
print(f"Success rate: {knowledge.success_rate:.1%}")
print(f"Bug-prone files: {knowledge.bug_prone}")
```

### 4. Memory Retrieval System (í†µí•© ì‹œìŠ¤í…œ)

ëª¨ë“  ë©”ëª¨ë¦¬ ë ˆì´ì–´ë¥¼ ì¡°ìœ¨í•©ë‹ˆë‹¤.

```python
from src.memory import create_memory_system

# ì „ì²´ ì‹œìŠ¤í…œ ìƒì„±
memory = create_memory_system()

# íƒœìŠ¤í¬ ì‹œì‘ ì‹œ ê´€ë ¨ ë©”ëª¨ë¦¬ ë¡œë“œ
memories = await memory.load_relevant_memories(
    task_description="Fix database timeout",
    task_type=TaskType.DEBUG,
    project_id="my-project",
    error_type="TimeoutError"
)

# Guidance í™œìš©
guidance = memories["guidance"]
print(f"Suggested approach: {guidance.suggested_approach}")
print(f"Things to try: {guidance.things_to_try}")
print(f"Things to avoid: {guidance.things_to_avoid}")

# ì‹¤í–‰ ì¤‘ ì¿¼ë¦¬
error_solutions = await memory.query_similar_error(
    error_type="TimeoutError"
)

# ì„¸ì…˜ ì¢…ë£Œ ì‹œ í•™ìŠµ
await memory.learn_from_session(episode)
```

## ğŸ”Œ Agent Orchestrator í†µí•©

ë©”ëª¨ë¦¬ ê¸°ëŠ¥ì„ ì¶”ê°€í•œ Orchestratorë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```python
from src.agent.orchestrator_with_memory import MemoryEnhancedOrchestrator
from src.agent.types import Task

# ë©”ëª¨ë¦¬ í†µí•© Orchestrator ìƒì„±
orchestrator = MemoryEnhancedOrchestrator(
    project_id="my-project",
    enable_memory=True
)

# íƒœìŠ¤í¬ ì‹¤í–‰ (ìë™ìœ¼ë¡œ ë©”ëª¨ë¦¬ ë¡œë“œ/ì €ì¥)
task = Task(query="Fix authentication bug", intent="debug")
result = await orchestrator.execute_task(task)

# ë©”ëª¨ë¦¬ í†µê³„
stats = await orchestrator.get_memory_statistics()
print(f"Total episodes: {stats['episodic']['total_episodes']}")
print(f"Bug patterns: {stats['semantic']['bug_patterns']}")
```

## ğŸ’¾ Persistence

### In-Memory (ê°œë°œ/í…ŒìŠ¤íŠ¸)

```python
from src.memory.persistence import InMemoryStore

store = InMemoryStore()
await store.save("episode-123", episode)
loaded = await store.load("episode-123")
```

### File-Based (ë¡œì»¬ ì €ì¥)

```python
from src.memory.persistence import FileStore

store = FileStore(base_path=".memory")
await store.save("episode-123", episode)
loaded = await store.load("episode-123")
```

### í–¥í›„ í™•ì¥

- PostgreSQL Store
- Redis Store
- Vector DB í†µí•© (Qdrant)

## ğŸ“Š ë©”íŠ¸ë¦­ & ë¶„ì„

```python
# Episodic memory í†µê³„
episodic_stats = episodic.get_statistics()
print(f"Total episodes: {episodic_stats['total_episodes']}")
print(f"Success rate: {episodic_stats['success_rate']:.1%}")
print(f"By type: {episodic_stats['by_type']}")

# Semantic memory í†µê³„
semantic_stats = semantic.get_statistics()
print(f"Bug patterns: {semantic_stats['bug_patterns']}")
print(f"Code patterns: {semantic_stats['code_patterns']}")

# ì „ì²´ ì‹œìŠ¤í…œ í†µê³„
memory_stats = memory.get_memory_statistics()
```

## ğŸ§ª ì˜ˆì œ

ì „ì²´ ì‚¬ìš© ì˜ˆì œëŠ” `examples/memory_system_example.py`ë¥¼ ì°¸ê³ í•˜ì„¸ìš”:

```bash
PYTHONPATH=. python examples/memory_system_example.py
```

## ğŸ¯ ì£¼ìš” ê¸°ëŠ¥

### âœ… í˜„ì¬ êµ¬í˜„ë¨

1. **Working Memory**
   - ì„¸ì…˜ ìƒíƒœ ì¶”ì 
   - Hypothesis/Decision ê´€ë¦¬
   - íŒŒì¼/ì‹¬ë³¼ ì¶”ì 
   - ì—í”¼ì†Œë“œ consolidation

2. **Episodic Memory**
   - ì—í”¼ì†Œë“œ ì €ì¥/ê²€ìƒ‰
   - ìœ ì‚¬ë„ ê²€ìƒ‰ (ì†ì„± ê¸°ë°˜)
   - ì—ëŸ¬ íŒ¨í„´ ê²€ìƒ‰
   - ìœ ìš©ì„± í”¼ë“œë°±

3. **Semantic Memory**
   - ë²„ê·¸ íŒ¨í„´ í•™ìŠµ
   - í”„ë¡œì íŠ¸ ì§€ì‹ ì¶”ì 
   - ì‚¬ìš©ì ì„ í˜¸ë„ í•™ìŠµ
   - íŒ¨í„´ ë§¤ì¹­

4. **Memory Retrieval**
   - íƒœìŠ¤í¬ë³„ ë©”ëª¨ë¦¬ ë¡œë“œ
   - ëŸ°íƒ€ì„ ì¿¼ë¦¬
   - Guidance ìƒì„±
   - í†µí•© í•™ìŠµ

5. **Persistence**
   - In-memory storage
   - File-based storage
   - í™•ì¥ ê°€ëŠ¥í•œ ì¸í„°í˜ì´ìŠ¤

6. **ë³´ì•ˆ & ì•ˆì •ì„±** (2025-11-25 ì—…ë°ì´íŠ¸)
   - Path injection ë°©ì–´ (base64 encoding + validation)
   - Circular reference ê°ì§€ (ì§ë ¬í™”)
   - Race condition ë°©ì§€ (asyncio locks)
   - Division by zero ë°©ì–´
   - Transaction íŒ¨í„´ (rollback ì§€ì›)
   - Memory leak ë°©ì§€ (ìë™ trimming)
   - Type safety (Enum validation)
   - ë³µì¡ë„ ìµœì í™” (í•¨ìˆ˜ ë¶„ë¦¬)

### ğŸš§ í–¥í›„ ê°œì„ 

1. **ë²¡í„° ê²€ìƒ‰**
   - Embedding ê¸°ë°˜ ìœ ì‚¬ë„ ê²€ìƒ‰
   - Qdrant/Pinecone í†µí•©

2. **íŒ¨í„´ ì¸ì‹**
   - AST ê¸°ë°˜ ì½”ë“œ íŒ¨í„´ ë§¤ì¹­
   - ì •ê·œí‘œí˜„ì‹ ì—ëŸ¬ ë©”ì‹œì§€ ë§¤ì¹­
   - Stack trace signature ë§¤ì¹­

3. **LLM í†µí•©**
   - ìë™ ì§€ì‹ ì¶”ì¶œ
   - íŒ¨í„´ ìš”ì•½ ìƒì„±
   - ìì—°ì–´ ê°€ì´ë˜ìŠ¤

4. **ê³ ê¸‰ ì €ì¥ì†Œ**
   - PostgreSQL adapter
   - Redis cache layer
   - ë¶„ì‚° ì €ì¥ì†Œ ì§€ì›

## ğŸ“š ì„¤ê³„ ë¬¸ì„œ

ìƒì„¸í•œ ì„¤ê³„ëŠ” [`_command_doc/E.ì—ì´ì „íŠ¸/memory.md`](../../_command_doc/E.ì—ì´ì „íŠ¸/memory.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

## ğŸ¤ ê¸°ì—¬

ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œì€ ì•„ì§ ì´ˆê¸° ë‹¨ê³„ì…ë‹ˆë‹¤. ê°œì„  ì‚¬í•­ì´ë‚˜ ë²„ê·¸ ë¦¬í¬íŠ¸ëŠ” í™˜ì˜í•©ë‹ˆë‹¤!
