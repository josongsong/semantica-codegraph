Semantica v2 Hexagonal Architecture - Inbound Ports & Adapters

전체 구조도
┌────────────────────────────────────────────────────────────────────────────────┐
│                                 Adapters (15개)                                 │
├────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬───────┤
│  CLI   │  IDE   │ WebUI  │  API   │  MCP   │ CI/CD  │ PR Bot │ Webhook│ Slack │
│  (P0)  │  (P0)  │  (P1)  │  (P0)  │  (P1)  │  (P1)  │  (P1)  │  (P1)  │ (P2)  │
├────────┼────────┼────────┼────────┼────────┴────────┴────────┴────────┼───────┤
│FileWatch│Schedule│Browser │Jupyter │         Discord / Teams / Mobile         │
│  (P2)  │  (P2)  │  (P2)  │  (P3)  │                 (P3)                      │
└────┬───┴────┬───┴────┬───┴────┬───┴────────────────────────────────────┬──────┘
     │        │        │        │                                        │
     ▼        ▼        ▼        ▼                                        ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                              Inbound Ports (15개)                               │
├────────────────────────────────────────────────────────────────────────────────┤
│ TaskPort │ ReviewPort │ QueryPort │ ExecutionPort │ ConfigPort │ VCSPort │ ... │
└────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                              Application Core                                   │
│                    (4-Layer + Meta Layers from ADR-001)                        │
└────────────────────────────────────────────────────────────────────────────────┘

Inbound Ports (15개)
Port목적핵심 메서드관련 ADRPriorityTaskPort작업 요청 진입점submitTask cancelTask getStatus001, 003P0ReviewPort승인/거절/코멘트approve reject comment requestModification009P0QueryPort정보 조회 (읽기 전용)explainCode searchSymbol searchPattern getFileTree005, 020P0ExecutionPort테스트/빌드/스크립트runTests runBuild runLinter runScript020, 026P0ConfigPort설정 변경updateGuardrail setLLMPreference setBudget setSecrets011, 021, 023P0ClarificationPort에이전트 질문 응답answer provideCustomAnswer skip022P1VCSPortGit 작업commit createBranch createPR getStatus getDiff014, 020P1ProjectPort프로젝트 관리activate onboard switchBranch getInfo001, 005P1SessionPort세션 관리create resume end getHistory010, 013P1StreamPort실시간 스트리밍subscribeProgress subscribeOutput onTyping024, 030P1WebhookPort외부 이벤트 수신onPROpened onPRComment onCIFailed onIssueCrated014P1ObservabilityPort추적/분석getTrace replayRun getMetrics exportAuditLog010, 015P2MemoryPort기억 관리save recall list forget007P2FileEventPort파일 변경 감지onFileSaved onFilesChanged-P2SchedulePort정기 실행register list cancel-P2

Adapters (15개)
CategoryAdapter사용 PortsPriorityInteractiveCLITask, Query, Execution, VCS, ConfigP0IDE ExtensionTask, Review, Query, Stream, FileEvent, ClarificationP0Web UITask, Review, Clarification, Session, ObservabilityP1Browser ExtensionTask, Review, QueryP2APIREST API전체 PortsP0MCP ServerTask, Query, ExecutionP1AutomationCI/CDTask, Execution, WebhookP1PR BotTask, Review, VCS, WebhookP1Webhook ReceiverWebhookP1File WatcherFileEvent, TaskP2SchedulerSchedule, TaskP2ChatSlackTask, Clarification, ReviewP2DiscordTask, Clarification, ReviewP3TeamsTask, Clarification, ReviewP3OtherJupyter/NotebookTask, Query, ExecutionP3Mobile AppReview, ObservabilityP3

Adapter-Port 매핑 매트릭스
TaskReviewQueryExecConfigClarifyVCSProjectSessionStreamWebhookObserveMemoryFileEvtScheduleCLI✅-✅✅✅-✅✅----✅--IDE✅✅✅✅✅✅✅✅✅✅---✅-Web UI✅✅✅-✅✅-✅✅✅-✅✅-✅REST API✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅MCP✅-✅✅-----------CI/CD✅--✅------✅----PR Bot✅✅✅--✅✅---✅----Webhook----------✅----File Watch✅------------✅-Scheduler✅-------------✅Slack✅✅---✅---------

Port 인터페이스 (핵심 5개)
pythonfrom abc import ABC, abstractmethod
from typing import Optional, List, AsyncIterator
from dataclasses import dataclass
from enum import Enum

# ═══════════════════════════════════════════════════════════
# DTOs
# ═══════════════════════════════════════════════════════════

@dataclass
class TaskRequest:
    prompt: str
    intent: Optional[str] = None           # REFACTOR, DEBUG, EDIT_CODE...
    file_context: Optional["FileContext"] = None
    options: Optional["TaskOptions"] = None

@dataclass
class TaskOptions:
    timeout_seconds: int = 300
    max_budget_usd: float = 1.0
    max_iterations: int = 10
    auto_approve: bool = False

class TaskState(Enum):
    PENDING = "pending"
    ANALYZING = "analyzing"
    GENERATING = "generating"
    TESTING = "testing"
    AWAITING_REVIEW = "awaiting_review"
    APPLYING = "applying"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"

@dataclass
class TaskStatus:
    task_id: str
    state: TaskState
    progress: float                         # 0.0 ~ 1.0
    current_step: Optional[str]
    proposal: Optional["Proposal"]
    error: Optional[str]

@dataclass
class Proposal:
    proposal_id: str
    hunks: List["Hunk"]
    test_result: Optional["TestResult"]
    visual_preview: Optional[str]           # ADR-025
    confidence: float                       # ADR-008

@dataclass
class ClarificationQuestion:
    question_id: str
    question: str
    options: List[str]                      # A, B, C 선택지 (ADR-022)
    context: Optional[str]

# ═══════════════════════════════════════════════════════════
# Inbound Ports
# ═══════════════════════════════════════════════════════════

class TaskPort(ABC):
    """작업 요청 진입점 (ADR-001, 003)"""

    @abstractmethod
    async def submit_task(self, request: TaskRequest) -> str:
        """TaskId 반환"""
        pass

    @abstractmethod
    async def cancel_task(self, task_id: str) -> None:
        pass

    @abstractmethod
    async def get_status(self, task_id: str) -> TaskStatus:
        pass

    @abstractmethod
    async def list_tasks(self, filter: Optional["TaskFilter"] = None) -> List[TaskStatus]:
        pass


class ReviewPort(ABC):
    """Human-in-the-loop (ADR-009)"""

    @abstractmethod
    async def approve(
        self,
        proposal_id: str,
        scope: str = "full",                # "full" | "partial"
        included_hunks: Optional[List[str]] = None
    ) -> None:
        pass

    @abstractmethod
    async def reject(self, proposal_id: str, reason: Optional[str] = None) -> None:
        pass

    @abstractmethod
    async def comment(self, proposal_id: str, hunk_id: str, comment: str) -> None:
        pass

    @abstractmethod
    async def request_modification(self, proposal_id: str, instruction: str) -> str:
        """새 TaskId 반환"""
        pass


class ClarificationPort(ABC):
    """에이전트 질문 응답 (ADR-022)"""

    @abstractmethod
    async def get_pending_questions(self, task_id: str) -> List[ClarificationQuestion]:
        pass

    @abstractmethod
    async def answer(self, question_id: str, selected_option: str) -> None:
        pass

    @abstractmethod
    async def answer_custom(self, question_id: str, free_text: str) -> None:
        pass

    @abstractmethod
    async def skip(self, question_id: str) -> None:
        pass


class QueryPort(ABC):
    """정보 조회 - 읽기 전용 (ADR-005, 020)"""

    @abstractmethod
    async def explain_code(self, file_path: str, start: int, end: int) -> str:
        pass

    @abstractmethod
    async def search_symbol(self, query: str, kinds: Optional[List[str]] = None) -> List["Symbol"]:
        pass

    @abstractmethod
    async def search_pattern(self, pattern: str, scope: Optional[str] = None) -> List["Match"]:
        pass

    @abstractmethod
    async def get_file_tree(self, path: str = ".", depth: int = 3) -> "FileTree":
        pass

    @abstractmethod
    async def get_file_content(self, path: str, start: Optional[int] = None, end: Optional[int] = None) -> str:
        pass


class WebhookPort(ABC):
    """외부 이벤트 수신 (ADR-014)"""

    @abstractmethod
    async def on_pr_opened(self, payload: "PRPayload") -> Optional[str]:
        """TaskId 반환 (자동 리뷰 시작 시)"""
        pass

    @abstractmethod
    async def on_pr_comment(self, payload: "CommentPayload") -> Optional[str]:
        """/fix, /refactor 등 커맨드 처리"""
        pass

    @abstractmethod
    async def on_ci_failed(self, payload: "CIPayload") -> Optional[str]:
        """자동 수정 시도"""
        pass

    @abstractmethod
    async def on_issue_created(self, payload: "IssuePayload") -> Optional[str]:
        pass
```

---

## 구현 Phase
```
Phase 1 - MVP (6주)
├── Ports: TaskPort, ReviewPort, QueryPort, ExecutionPort, ConfigPort
└── Adapters: CLI, IDE Extension, REST API

Phase 2 - Automation (3주)
├── Ports: ClarificationPort, VCSPort, WebhookPort, SessionPort
└── Adapters: CI/CD, PR Bot, Webhook Receiver, MCP

Phase 3 - UX (3주)
├── Ports: StreamPort, ProjectPort, ObservabilityPort
└── Adapters: Web UI, Browser Extension, File Watcher

Phase 4 - Extended (2주)
├── Ports: MemoryPort, FileEventPort, SchedulePort
└── Adapters: Slack, Scheduler, Jupyter

Phase 5 - Optional
└── Adapters: Discord, Teams, Mobile
```

---

## 시나리오별 플로우 예시

### 1. IDE에서 리팩토링 요청
```
[User] IDE에서 코드 선택 → "Refactor this" 클릭
         │
         ▼
[IDE Adapter] ──→ TaskPort.submitTask({
                    prompt: "Refactor this",
                    file_context: { file, selection }
                  })
         │
         ▼
[Core] Layer1(Router) → Layer2(Workflow) → Layer3(Sandbox)
         │
         ▼
[Core] ──→ StreamPort.subscribeProgress() ──→ [IDE Adapter] 진행상황 표시
         │
         ▼
[Core] Proposal 생성, state=AWAITING_REVIEW
         │
         ▼
[IDE Adapter] ←── TaskPort.getStatus() ←── Proposal with Diff
         │
         ▼
[User] Diff 확인 → Approve 클릭
         │
         ▼
[IDE Adapter] ──→ ReviewPort.approve(proposalId)
         │
         ▼
[Core] Shadow → Real 반영, state=COMPLETED
```

---

### 2. PR Bot이 자동 리뷰
```
[GitHub] PR Opened
         │
         ▼
[Webhook Adapter] ──→ WebhookPort.onPROpened(payload)
         │
         ▼
[Core] 자동 TaskRequest 생성, 코드 분석
         │
         ▼
[Core] 문제 발견 시 Proposal 생성
         │
         ▼
[PR Bot Adapter] ←── VCSPort.createPRComment(suggestion)
         │
         ▼
[GitHub] PR에 코멘트로 수정 제안 표시
         │
         ▼
[User] "/apply" 코멘트 작성
         │
         ▼
[Webhook Adapter] ──→ WebhookPort.onPRComment(payload)
         │
         ▼
[Core] ReviewPort.approve() 처리, 커밋 push
