name: Parsers CI - codegraph-parsers ν…μ¤νΈ

on:
  pull_request:
    paths:
      - 'packages/codegraph-parsers/**'
      - '.github/workflows/parsers-ci.yml'
  push:
    branches: [main, develop]
    paths:
      - 'packages/codegraph-parsers/**'

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ========================================================================
  # 1. Parser λ‹¨μ„ ν…μ¤νΈ
  # ========================================================================
  test-parsers:
    name: Parser λ‹¨μ„ ν…μ¤νΈ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Python μ„¤μ •
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: codegraph-parsers μ„¤μΉ
        run: |
          pip install --upgrade pip
          pip install -e packages/codegraph-parsers
          pip install -e "packages/codegraph-parsers[dev]"

      - name: pytest μ‹¤ν–‰
        run: |
          cd packages/codegraph-parsers
          pytest tests/ -v --tb=short --cov=codegraph_parsers --cov-report=xml

      - name: μ»¤λ²„λ¦¬μ§€ μ—…λ΅λ“
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.12'
        with:
          files: packages/codegraph-parsers/coverage.xml
          flags: parsers
          name: parsers-coverage

  # ========================================================================
  # 2. Rust PyO3 ν†µν•© ν…μ¤νΈ
  # ========================================================================
  test-rust-integration:
    name: Rust PyO3 ν†µν•©
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Python μ„¤μ •
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Rust μ„¤μ •
        uses: dtolnay/rust-toolchain@stable

      - name: codegraph-parsers μ„¤μΉ
        run: |
          pip install --upgrade pip
          pip install -e packages/codegraph-parsers

      - name: Rust μ»΄νμΌ ν…μ¤νΈ (Python feature)
        run: |
          cd packages/codegraph-rust/codegraph-ir
          cargo check --features python

      - name: Rust λ‹¨μ„ ν…μ¤νΈ
        run: |
          cd packages/codegraph-rust/codegraph-ir
          cargo test --features python --lib
        continue-on-error: true

  # ========================================================================
  # 3. ν†µν•© ν…μ¤νΈ
  # ========================================================================
  test-integration:
    name: ν†µν•© ν…μ¤νΈ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Python μ„¤μ •
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: codegraph-parsers μ„¤μΉ
        run: |
          pip install --upgrade pip
          pip install -e packages/codegraph-parsers

      - name: ν†µν•© ν…μ¤νΈ μ‹¤ν–‰
        run: |
          python3 test_parser_integration.py

  # ========================================================================
  # 4. μ½”λ“ ν’μ§ κ²€μ¦
  # ========================================================================
  lint-parsers:
    name: Parser μ½”λ“ ν’μ§
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Python μ„¤μ •
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Linter μ„¤μΉ
        run: |
          pip install --upgrade pip
          pip install ruff black

      - name: Ruff (Linting)
        run: |
          ruff check packages/codegraph-parsers/codegraph_parsers/ --output-format=github
        continue-on-error: true

      - name: Black (Formatting)
        run: |
          black --check packages/codegraph-parsers/codegraph_parsers/
        continue-on-error: true

  # ========================================================================
  # 5. λ²„μ „ νΈν™μ„± ν…μ¤νΈ
  # ========================================================================
  test-compatibility:
    name: νΈν™μ„± ν…μ¤νΈ
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Python μ„¤μ •
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: codegraph-parsers μ„¤μΉ
        run: |
          pip install --upgrade pip
          pip install -e packages/codegraph-parsers

      - name: Import ν…μ¤νΈ
        run: |
          python -c "from codegraph_parsers import JSXTemplateParser, VueSFCParser, MarkdownParser, NotebookParser; print('β… νΈν™μ„± ν…μ¤νΈ ν†µκ³Ό')"

  # ========================================================================
  # 6. κ²°κ³Ό μ”μ•½
  # ========================================================================
  summary:
    name: ν…μ¤νΈ κ²°κ³Ό μ”μ•½
    runs-on: ubuntu-latest
    needs: [test-parsers, test-rust-integration, test-integration, lint-parsers, test-compatibility]
    if: always()

    steps:
      - name: ν…μ¤νΈ κ²°κ³Ό μ¶λ ¥
        run: |
          echo "## π― codegraph-parsers CI κ²°κ³Ό" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "β… Parser λ‹¨μ„ ν…μ¤νΈ: ${{ needs.test-parsers.result }}" >> $GITHUB_STEP_SUMMARY
          echo "β… Rust PyO3 ν†µν•©: ${{ needs.test-rust-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "β… ν†µν•© ν…μ¤νΈ: ${{ needs.test-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "β… μ½”λ“ ν’μ§: ${{ needs.lint-parsers.result }}" >> $GITHUB_STEP_SUMMARY
          echo "β… νΈν™μ„± ν…μ¤νΈ: ${{ needs.test-compatibility.result }}" >> $GITHUB_STEP_SUMMARY
