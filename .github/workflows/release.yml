name: Release - 버전 관리

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # ========================================================================
  # 1. 릴리스 노트 생성
  # ========================================================================
  create-release:
    name: 릴리스 생성
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: release_notes
        run: |
          # 이전 태그 찾기
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          echo "## 변경사항" > release_notes.md
          echo "" >> release_notes.md

          if [ -n "$PREVIOUS_TAG" ]; then
            git log ${PREVIOUS_TAG}..${CURRENT_TAG} \
              --pretty=format:"- %s (%an)" \
              --no-merges >> release_notes.md
          else
            git log ${CURRENT_TAG} \
              --pretty=format:"- %s (%an)" \
              --no-merges >> release_notes.md
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================================
  # 2. 도커 이미지 태그 업데이트
  # ========================================================================
  tag-docker-images:
    name: 도커 이미지 태그
    runs-on: ubuntu-latest
    needs: create-release
    timeout-minutes: 15

    permissions:
      packages: write

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag as Latest
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          IMAGE=ghcr.io/${{ github.repository }}

          docker pull ${IMAGE}:${VERSION}
          docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
          docker push ${IMAGE}:latest

          echo "✅ Tagged as latest: ${VERSION}"

  # ========================================================================
  # 3. 변경사항 분석
  # ========================================================================
  analyze-changes:
    name: 변경사항 분석
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Changes
        run: |
          echo "## 변경 통계" > changes.md
          echo "" >> changes.md

          # 파일 변경
          echo "### 파일 변경" >> changes.md
          git diff --stat $(git describe --tags --abbrev=0 HEAD^)..HEAD >> changes.md

          # 기여자
          echo "" >> changes.md
          echo "### 기여자" >> changes.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD \
            --format='%aN' | sort -u >> changes.md

          cat changes.md

      - name: Upload Changes Analysis
        uses: actions/upload-artifact@v4
        with:
          name: changes-analysis
          path: changes.md
