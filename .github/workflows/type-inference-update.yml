name: Type Inference Update

on:
  schedule:
    # Monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      source:
        description: 'Source for type generation'
        required: true
        default: 'gaps'
        type: choice
        options:
          - gaps
          - typeshed
      module:
        description: 'Specific module (typeshed only)'
        required: false
        type: string

jobs:
  update-types:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Clone typeshed (if needed)
        if: github.event.inputs.source == 'typeshed' || github.event_name == 'schedule'
        run: |
          git clone --depth 1 https://github.com/python/typeshed vendor/typeshed

      - name: Run benchmark for gap analysis
        if: github.event.inputs.source == 'gaps' || github.event_name == 'schedule'
        run: |
          pip install -e .
          PYTHONPATH=. python -m src.contexts.code_foundation.infrastructure.type_inference.scripts.run_type_inference_benchmark || true

      - name: Generate from gaps
        if: github.event.inputs.source == 'gaps' || github.event_name == 'schedule'
        run: |
          PYTHONPATH=. python -m src.contexts.code_foundation.infrastructure.type_inference.scripts.generate_builtin_types --from-gaps --min-count 10

      - name: Generate from typeshed
        if: github.event.inputs.source == 'typeshed'
        run: |
          MODULE_ARG=""
          if [ -n "${{ github.event.inputs.module }}" ]; then
            MODULE_ARG="--module ${{ github.event.inputs.module }}"
          fi
          PYTHONPATH=. python -m src.contexts.code_foundation.infrastructure.type_inference.scripts.generate_builtin_types --source typeshed $MODULE_ARG

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet src/contexts/code_foundation/infrastructure/type_inference/configs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(type-inference): update builtin type configs'
          title: 'chore(type-inference): Update builtin type configs'
          body: |
            ## Type Inference Config Update

            This PR was auto-generated by the type-inference-update workflow.

            ### Changes
            - Updated builtin method configurations based on ${{ github.event.inputs.source || 'gap analysis' }}

            ### Validation
            - [ ] Run `PYTHONPATH=. python scripts/run_type_inference_benchmark.py` to verify improvement
            - [ ] Review generated YAML for accuracy

            ---
            Generated at: ${{ github.run_id }}
          branch: auto/type-inference-update
          delete-branch: true
          labels: |
            type-inference
            auto-generated
