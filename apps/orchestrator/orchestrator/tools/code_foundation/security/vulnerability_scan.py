"""
Detect Vulnerabilities Tool

Code Foundation 통합: Deep Security Analyzer + Taint Analysis
"""

import logging

from ..base import CodeFoundationTool, ToolCategory, ToolMetadata, ToolResult

logger = logging.getLogger(__name__)


class DetectVulnerabilitiesTool(CodeFoundationTool):
    """
    취약점 탐지 도구

    기능:
    - SQL 인젝션, XSS 등 보안 취약점
    - Taint 분석
    - 심층 보안 스캔

    Code Foundation:
    - DeepSecurityAnalyzer: 보안 분석
    - TaintEngine: 오염 추적
    """

    def __init__(self, security_analyzer, taint_engine):
        self.security_analyzer = security_analyzer
        self.taint_engine = taint_engine

    @property
    def metadata(self) -> ToolMetadata:
        return ToolMetadata(
            name="detect_vulnerabilities",
            description=(
                "코드의 보안 취약점을 탐지합니다. "
                "SQL 인젝션, XSS, 명령 인젝션, 하드코딩된 비밀 등 "
                "다양한 보안 이슈를 Taint 분석으로 찾아냅니다."
            ),
            category=ToolCategory.SECURITY_ANALYSIS,
            input_schema={
                "type": "object",
                "properties": {
                    "file_path": {"type": "string", "description": "스캔할 파일"},
                    "scan_mode": {
                        "type": "string",
                        "enum": ["quick", "deep", "audit"],
                        "description": "스캔 모드",
                        "default": "quick",
                        "optional": True,
                    },
                },
                "required": ["file_path"],
            },
            output_schema={
                "type": "object",
                "properties": {
                    "vulnerabilities": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "type": {"type": "string"},
                                "severity": {"type": "string"},
                                "location": {"type": "object"},
                                "description": {"type": "string"},
                                "confidence": {"type": "number"},
                            },
                        },
                    },
                    "total_issues": {"type": "integer"},
                    "critical_count": {"type": "integer"},
                },
            },
            complexity=5,
            dependencies=[],
            tags=["security", "vulnerability", "taint", "injection"],
            version="1.0.0",
            stability="stable",
        )

    def execute(self, file_path: str, scan_mode: str = "quick") -> ToolResult:
        """취약점 탐지"""
        try:
            logger.info(f"Scanning {file_path} (mode={scan_mode})")

            # 보안 스캔
            issues = self.security_analyzer.analyze(file_path=file_path, mode=scan_mode)

            # 결과 구성
            vulnerabilities = []
            critical_count = 0

            for issue in issues:
                vuln = {
                    "type": issue.issue_type,
                    "severity": issue.severity,
                    "location": {"file": issue.file, "line": issue.line, "column": issue.column},
                    "description": issue.message,
                    "confidence": issue.confidence,
                    "taint_path": issue.taint_path if hasattr(issue, "taint_path") else None,
                }
                vulnerabilities.append(vuln)

                if issue.severity == "CRITICAL":
                    critical_count += 1

            return ToolResult(
                success=True,
                data={
                    "vulnerabilities": vulnerabilities,
                    "total_issues": len(vulnerabilities),
                    "critical_count": critical_count,
                    "scan_mode": scan_mode,
                },
                confidence=0.88,
            )

        except Exception as e:
            logger.exception("Error detecting vulnerabilities")
            return ToolResult(success=False, data=None, error=str(e), confidence=0.0)
