# B. ì¸ë±ì‹± ë ˆì´ì–´ êµ¬í˜„ ê³„íš (ìµœì¢…)

## ğŸ“‹ ë¬¸ì„œ ê°œìš”

**ëª©ì **: "_command_doc/B. ì¸ë±ì‹±/" í•˜ìœ„ ë¬¸ì„œë“¤ê³¼ í˜„ì¬ êµ¬í˜„ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ, Index Layerì˜ ì „ì²´ êµ¬í˜„ ê³„íšì„ ë‹¨ê³„ë³„ë¡œ ì •ë¦¬

**ì°¸ì¡° ë¬¸ì„œ**:
- [00.Overview.md](00.Overview.md) - ì „ì²´ ì•„í‚¤í…ì²˜
- [01.Chunk_to_IndexDocument_Lexical.md](01.Chunk_to_IndexDocument_Lexical.md) - Zoekt Hybrid êµ¬í˜„ ê°€ì´ë“œ
- [02.usecase](02.usecase) - í•µì‹¬/ë² ì´ìŠ¤/ì—£ì§€ì¼€ì´ìŠ¤ ëª©ë¡
- [03.Implementation_Strategy.md](03.Implementation_Strategy.md) - êµ¬í˜„ ì „ëµ ë° ì´ìŠˆ
- [../ì¸ë±ì‹±ì „ëµ.md](../ì¸ë±ì‹±ì „ëµ.md) - ì„¸ë¶€ ì„¤ê³„ ëª…ì„¸

---

## 1. ì „ì²´ ì•„í‚¤í…ì²˜ ìš”ì•½

### 1.1 Index Layerì˜ ì—­í• 

Chunk/IR/Graph ê¸°ë°˜ì˜ ì •ê·œí™”ëœ ë°ì´í„°ë¥¼ **6ê°œ ì¸ë±ìŠ¤**ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ê³„ì¸µ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Foundation Layer (ì´ë¯¸ ì™„ë£Œ)                â”‚
â”‚  Chunk, IR, Graph, Semantic IR, RepoMap                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Index Layer (ë³¸ ê³„íš)                   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Lexical    â”‚   â”‚   Vector    â”‚   â”‚   Symbol    â”‚  â”‚
â”‚  â”‚  (Zoekt)    â”‚   â”‚  (Qdrant)   â”‚   â”‚   (Kuzu)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Fuzzy     â”‚   â”‚   Domain    â”‚   â”‚   Runtime   â”‚  â”‚
â”‚  â”‚ (pg_trgm)   â”‚   â”‚ (Qdrant)    â”‚   â”‚  (Phase 3)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
            ê³µí†µ SearchHit ìŠ¤í‚¤ë§ˆ
```

### 1.2 í•µì‹¬ ì„¤ê³„ ì›ì¹™

1. **Lexical = Zoekt ì „ìš©**
   - íŒŒì¼ ê¸°ë°˜ ê²€ìƒ‰ â†’ ChunkStore ë§¤í•‘ìœ¼ë¡œ chunk ë‹¨ìœ„ ê²°ê³¼ ì œê³µ
   - IndexDocumentëŠ” Vector/Domainì—ì„œë§Œ ì‚¬ìš©

2. **snapshot_id ê¸°ë°˜ ì¼ê´€ì„±**
   - ëª¨ë“  ì¸ë±ìŠ¤ëŠ” repo_id + snapshot_id ì¡°í•©ìœ¼ë¡œ ê´€ë¦¬
   - IR/Graph/RepoMapê³¼ ë™ì¼í•œ snapshot ê¸°ì¤€ ì‚¬ìš©

3. **ì¦ë¶„ ì¸ë±ì‹± ìš°ì„ **
   - ChunkRefreshResult ê¸°ë°˜ Delta ì—…ë°ì´íŠ¸
   - Full reindexëŠ” ìµœì†Œí™”

4. **Port/DI ê¸°ë°˜ í™•ì¥ì„±**
   - ê° ì¸ë±ìŠ¤ëŠ” Port ì¸í„°í˜ì´ìŠ¤ë¡œ ì¶”ìƒí™”
   - ë°±ì—”ë“œ êµì²´/ì¶”ê°€ ê°€ëŠ¥í•œ êµ¬ì¡°

---

## 2. í˜„ì¬ êµ¬í˜„ ìƒíƒœ (2024-11-24 ê¸°ì¤€)

### âœ… ì™„ë£Œëœ í•­ëª©

#### 2.1 Core ìŠ¤í‚¤ë§ˆ ë° ë³€í™˜ê¸°
- **IndexDocument, SearchHit** ([src/index/common/documents.py](../../src/index/common/documents.py))
  - snapshot_id í•„ë“œ í¬í•¨
  - 6ê°œ source íƒ€ì… ì§€ì› (lexical/vector/symbol/fuzzy/domain/runtime)

- **IndexDocumentTransformer** ([src/index/common/transformer.py](../../src/index/common/transformer.py))
  - Chunk â†’ IndexDocument ë³€í™˜ ì™„ë£Œ
  - RepoMap importance í†µí•© (repomap_score, pagerank_score)
  - Parent-child hierarchy tags
  - Entrypoint/test í”Œë˜ê·¸

- **IndexingService** ([src/index/service.py](../../src/index/service.py))
  - 6ê°œ ì¸ë±ìŠ¤ í†µí•© ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°
  - index_repo_full / index_repo_incremental êµ¬ì¡°
  - Weighted fusion ê²€ìƒ‰ ì§€ì›

#### 2.2 í…ŒìŠ¤íŠ¸
- **Index Transformer í…ŒìŠ¤íŠ¸** ([tests/index/test_transformer.py](../../tests/index/test_transformer.py))
  - 6ê°œ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼
  - RepoMap í†µí•© ê²€ì¦ ì™„ë£Œ

### â³ ë¶€ë¶„ êµ¬í˜„ (ì¸í„°í˜ì´ìŠ¤ë§Œ ì¡´ì¬)

- **Index ì–´ëŒ‘í„° ë””ë ‰í† ë¦¬ êµ¬ì¡°**
  - `src/index/lexical/` - __init__.pyë§Œ ì¡´ì¬
  - `src/index/vector/` - __init__.pyë§Œ ì¡´ì¬
  - `src/index/symbol/` - __init__.pyë§Œ ì¡´ì¬
  - `src/index/fuzzy/` - __init__.pyë§Œ ì¡´ì¬
  - `src/index/domain_meta/` - __init__.pyë§Œ ì¡´ì¬
  - `src/index/runtime/` - __init__.pyë§Œ ì¡´ì¬

### âŒ ë¯¸êµ¬í˜„ í•­ëª©

1. **Index Ports ì •ì˜** (src/ports.pyì— ì¶”ê°€)
   - LexicalIndexPort
   - VectorIndexPort
   - SymbolIndexPort
   - FuzzyIndexPort
   - DomainMetaIndexPort
   - RuntimeIndexPort

2. **ì‹¤ì œ ì–´ëŒ‘í„° êµ¬í˜„**
   - Zoekt Adapter
   - Qdrant Adapter
   - Kuzu Symbol Adapter
   - PostgreSQL Fuzzy Adapter
   - Domain Meta Adapter

3. **ChunkStore í™•ì¥**
   - find_chunk_by_file_and_line() ë©”ì„œë“œ
   - DB ì¸ë±ìŠ¤ (idx_chunks_file_span)

4. **Snapshot ë©”íƒ€ ê´€ë¦¬**
   - lexical_index_snapshots í…Œì´ë¸”
   - lexical_index_jobs í…Œì´ë¸”

---

## 3. êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë° ë‹¨ê³„ë³„ ê³„íš

### Phase 1: MVP - Core Infrastructure (2ì£¼)

**ëª©í‘œ**: Lexical(Zoekt) + Vector(Qdrant) ê¸°ë³¸ ë™ì‘ ì™„ì„±

#### Week 1: Foundation & Ports (5ì¼)

**Day 1-2: Ports ì •ì˜ ë° ChunkStore í™•ì¥**
```python
# src/ports.pyì— ì¶”ê°€
class LexicalIndexPort(Protocol):
    """Zoekt ê¸°ë°˜ Lexical ê²€ìƒ‰"""
    def reindex_repo(self, repo_id: str, snapshot_id: str) -> None: ...
    def reindex_paths(self, repo_id: str, snapshot_id: str, paths: list[str]) -> None: ...
    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]: ...
    def delete_repo(self, repo_id: str, snapshot_id: str) -> None: ...

class VectorIndexPort(Protocol):
    """Qdrant ê¸°ë°˜ Vector ê²€ìƒ‰"""
    def index(
        self,
        repo_id: str,
        snapshot_id: str,
        docs: list[IndexDocument]
    ) -> None: ...
    def upsert(
        self,
        repo_id: str,
        snapshot_id: str,
        docs: list[IndexDocument]
    ) -> None: ...
    def delete(
        self,
        repo_id: str,
        snapshot_id: str,
        doc_ids: list[str]
    ) -> None: ...
    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]: ...
```

- **ChunkStore í™•ì¥** ([src/foundation/chunk/store.py](../../src/foundation/chunk/store.py))
```python
def find_chunk_by_file_and_line(
    self,
    repo_id: str,
    file_path: str,
    line: int,
) -> Chunk | None:
    """
    Zoekt ê²°ê³¼(file+line) â†’ Chunk ë§¤í•‘
    ìš°ì„ ìˆœìœ„: function > class > file
    """
```

- **DB Migration**: idx_chunks_file_span ì¸ë±ìŠ¤ ì¶”ê°€
```sql
CREATE INDEX idx_chunks_file_span
ON chunks (repo_id, file_path, start_line, end_line);
```

**Day 3-4: Snapshot ë©”íƒ€ êµ¬ì¡°**

- **lexical_index_snapshots í…Œì´ë¸”**
```sql
CREATE TABLE lexical_index_snapshots (
    repo_id        TEXT NOT NULL,
    snapshot_id    TEXT NOT NULL,   -- ì—”ì§„ ê³µí†µ snapshot_id
    backend        TEXT NOT NULL,   -- 'zoekt'
    index_version  TEXT NOT NULL,   -- Zoekt ì¸ë±ìŠ¤ ë””ë ‰í† ë¦¬ëª…
    is_ready       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (repo_id, snapshot_id, backend)
);
```

- **lexical_index_jobs í…Œì´ë¸”**
```sql
CREATE TABLE lexical_index_jobs (
    job_id        TEXT PRIMARY KEY,
    repo_id       TEXT NOT NULL,
    snapshot_id   TEXT NOT NULL,
    backend       TEXT NOT NULL,
    status        TEXT NOT NULL,   -- PENDING/RUNNING/SUCCESS/FAILED
    log_path      TEXT,
    started_at    TIMESTAMPTZ,
    finished_at   TIMESTAMPTZ
);
```

**Day 5: QueryBuilder ë° Helper ìœ í‹¸**

- **QueryBuilder** ([src/index/lexical/query_builder.py](../../src/index/lexical/query_builder.py))
```python
def build_zoekt_query(
    user_query: str,
    repo: str | None = None,
    language: str | None = None,
    file_prefix: str | None = None,
) -> str:
    """Zoekt DSL ì¿¼ë¦¬ ìƒì„±"""
```

- **RepoPathResolver** ([src/index/lexical/path_resolver.py](../../src/index/lexical/path_resolver.py))
```python
class RepoPathResolver:
    """repo_id â†” filesystem path â†” zoekt repo name ë§¤í•‘"""
    def get_fs_path(self, repo_id: str) -> str: ...
    def get_zoekt_repo_name(self, repo_id: str) -> str: ...
```

#### Week 2: Zoekt & Qdrant Adapter (5ì¼)

**Day 1-3: Zoekt Adapter**

- **ZoektLexicalIndex** ([src/index/lexical/adapter_zoekt.py](../../src/index/lexical/adapter_zoekt.py))
```python
class ZoektLexicalIndex:
    """Zoekt Hybrid: íŒŒì¼ ê²€ìƒ‰ â†’ Chunk ë§¤í•‘"""

    def __init__(
        self,
        http_endpoint: str,
        repo_mapper: RepoPathResolver,
        chunk_store: ChunkStore,
    ): ...

    def reindex_repo(self, repo_id: str, snapshot_id: str) -> None:
        """Zoekt ì „ì²´ ì¬ì¸ë±ì‹±"""
        repo_path = self.repo_mapper.get_fs_path(repo_id)
        # subprocess: zoekt-index -index {zoekt_repo} {repo_path}
        ...

    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]:
        """
        Zoekt ê²€ìƒ‰ â†’ file+line â†’ ChunkStore ë§¤í•‘
        ë§¤í•‘ ì‹¤íŒ¨ ì‹œ fallback ì „ëµ:
        1. ì •í™•í•œ function/class chunk â†’ score 1.0
        2. íŒŒì¼ chunk â†’ score 0.8
        3. ê°€ìƒ chunk_id â†’ score 0.5 + warning
        """
        zoekt_query = build_zoekt_query(query, repo=repo_id)
        raw_results = self._zoekt_http_search(zoekt_query, limit)

        hits: list[SearchHit] = []
        for r in raw_results:
            chunk = self.chunk_store.find_chunk_by_file_and_line(
                repo_id=repo_id,
                file_path=r["file_path"],
                line=r["line_number"],
            )

            if chunk:
                hits.append(SearchHit(
                    chunk_id=chunk.chunk_id,
                    file_path=r["file_path"],
                    symbol_id=chunk.symbol_id,
                    score=r["score"],
                    source="lexical",
                    metadata={
                        "line": r["line_number"],
                        "preview": r["context"],
                        "kind": chunk.kind,
                        "mapped": True,
                    },
                ))
            else:
                # Fallback: ê°€ìƒ chunk_id
                hits.append(SearchHit(
                    chunk_id=f"virtual:{repo_id}:{r['file_path']}:{r['line_number']}",
                    file_path=r["file_path"],
                    symbol_id=None,
                    score=r["score"] * 0.5,
                    source="lexical",
                    metadata={
                        "line": r["line_number"],
                        "preview": r["context"],
                        "mapped": False,
                        "warning": "chunk_mapping_failed",
                    },
                ))

        return hits[:limit]
```

**Day 4-5: Qdrant Adapter**

- **QdrantVectorIndex** ([src/index/vector/adapter_qdrant.py](../../src/index/vector/adapter_qdrant.py))
```python
class QdrantVectorIndex:
    """Qdrant ê¸°ë°˜ Vector ê²€ìƒ‰"""

    def __init__(
        self,
        qdrant_client: QdrantClient,
        embedding_provider: EmbeddingProvider,
        collection_prefix: str = "code_embeddings",
    ): ...

    def index(
        self,
        repo_id: str,
        snapshot_id: str,
        docs: list[IndexDocument]
    ) -> None:
        """ì „ì²´ ì¸ë±ì‹±: collection ìƒì„± + ë²¡í„° upsert"""
        collection_name = f"{self.collection_prefix}_{repo_id}_{snapshot_id}"

        # 1. Collection ìƒì„± (ì—†ìœ¼ë©´)
        self._ensure_collection(collection_name, vector_size=1536)

        # 2. Embedding ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬)
        vectors = []
        for batch in chunked(docs, batch_size=256):
            texts = [doc.content for doc in batch]
            embeddings = self.embedding_provider.embed_batch(texts)
            vectors.extend(embeddings)

        # 3. Qdrant upsert
        points = [
            PointStruct(
                id=doc.chunk_id,
                vector=vec,
                payload={
                    "repo_id": repo_id,
                    "snapshot_id": snapshot_id,
                    "file_path": doc.file_path,
                    "symbol_fqn": doc.symbol_fqn,
                    "kind": doc.kind,
                    "tags": doc.tags,
                    "importance_score": doc.importance_score,
                },
            )
            for doc, vec in zip(docs, vectors)
        ]

        self.client.upsert(collection_name=collection_name, points=points)

    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]:
        """Vector ê²€ìƒ‰: ìì—°ì–´ ì¿¼ë¦¬ â†’ embedding â†’ Qdrant search"""
        collection_name = f"{self.collection_prefix}_{repo_id}_{snapshot_id}"

        # 1. Query embedding
        query_vector = self.embedding_provider.embed(query)

        # 2. Qdrant search
        results = self.client.search(
            collection_name=collection_name,
            query_vector=query_vector,
            limit=limit,
        )

        # 3. SearchHit ë³€í™˜
        return [
            SearchHit(
                chunk_id=r.id,
                file_path=r.payload.get("file_path"),
                symbol_id=r.payload.get("symbol_id"),
                score=r.score,
                source="vector",
                metadata=r.payload,
            )
            for r in results
        ]
```

### Phase 2: Quality & Testing (1ì£¼)

**Week 3: í…ŒìŠ¤íŠ¸ ë° íŠœë‹**

**Day 1-2: Unit Tests**
- Transformer í…ŒìŠ¤íŠ¸ (ì´ë¯¸ ì™„ë£Œ)
- ChunkStore.find_chunk_by_file_and_line í…ŒìŠ¤íŠ¸
- ZoektLexicalIndex í…ŒìŠ¤íŠ¸
- QdrantVectorIndex í…ŒìŠ¤íŠ¸

**Day 3-4: Integration Tests**
- ì‹¤ì œ Git repo + Zoekt + ChunkStore E2E
- Usecase ê²€ì¦:
  - [C1] í•¨ìˆ˜/ë©”ì„œë“œ ì •ì˜ ìœ„ì¹˜ ì°¾ê¸°
  - [C4] ì‹¬ë³¼ ì´ë¦„/identifier ê²€ìƒ‰
  - [B1] ë‹¨ìˆœ ë¬¸ìì—´ ê²€ìƒ‰
  - [E1] ì¸ë±ìŠ¤ ë¶€ì¬ ì²˜ë¦¬
  - [E4] ë™ì¼ ì´ë¦„ ì‹¬ë³¼ ë¶„ë¦¬

**Day 5: ì„±ëŠ¥ íŠœë‹ ë° ëª¨ë‹ˆí„°ë§**
- Zoekt ê²€ìƒ‰ latency (p95 < 500ms)
- Chunk ë§¤í•‘ ì‹¤íŒ¨ìœ¨ (< 5%)
- DB ì¿¼ë¦¬ ìµœì í™” (find_chunk_by_file_and_line)
- Metrics ì¶”ê°€:
  - `zoekt_mapping_failure_total{repo_id}`
  - `zoekt_mapping_failure_by_reason{reason}`
  - `qdrant_upsert_latency_seconds{repo_id}`

### Phase 3: Symbol/Fuzzy/Domain (2ì£¼)

**Week 4: Symbol & Fuzzy Adapter**

**Day 1-3: Symbol Index (Kuzu Wrapper)**

- **KuzuSymbolIndex** ([src/index/symbol/adapter_kuzu.py](../../src/index/symbol/adapter_kuzu.py))
```python
class KuzuSymbolIndex:
    """Kuzu Graph ê¸°ë°˜ Symbol ê²€ìƒ‰ (thin wrapper)"""

    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]:
        """
        Symbol ê²€ìƒ‰: go-to-definition, find-references
        Graph ì¿¼ë¦¬ â†’ SearchHit ë³€í™˜
        """
        # Cypher ì¿¼ë¦¬ ì˜ˆì‹œ:
        # MATCH (n:Symbol {name: $query, repo_id: $repo_id, snapshot_id: $snapshot_id})
        # RETURN n.chunk_id, n.file_path, n.symbol_id
        ...
```

**Day 4-5: Fuzzy Index (pg_trgm)**

- **PostgresFuzzyIndex** ([src/index/fuzzy/adapter_pgtrgm.py](../../src/index/fuzzy/adapter_pgtrgm.py))
```python
class PostgresFuzzyIndex:
    """PostgreSQL trigram ê¸°ë°˜ Fuzzy ê²€ìƒ‰"""

    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]:
        """
        ì˜¤íƒ€/incomplete query ëŒ€ì‘
        identifier, symbol_name, file_pathì—ì„œ fuzzy match
        """
        # SELECT chunk_id, symbol_fqn, similarity(symbol_fqn, $query) AS score
        # FROM chunk_index
        # WHERE repo_id = $repo_id
        #   AND snapshot_id = $snapshot_id
        #   AND symbol_fqn % $query  -- trigram ìœ ì‚¬ë„
        # ORDER BY score DESC
        # LIMIT $limit
        ...
```

**Week 5: Domain Meta Index**

- **DomainMetaIndex** ([src/index/domain_meta/adapter_meta.py](../../src/index/domain_meta/adapter_meta.py))
```python
class DomainMetaIndex:
    """README/ADR/API Spec ê²€ìƒ‰ (Qdrant ë³„ë„ ì»¬ë ‰ì…˜)"""

    def index_documents(
        self,
        repo_id: str,
        snapshot_id: str,
        docs: list[DomainDocument]
    ) -> None:
        """ë„ë©”ì¸ ë¬¸ì„œ ì¸ë±ì‹± (ìš”ì•½ â†’ embedding)"""
        ...

    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50
    ) -> list[SearchHit]:
        """ìì—°ì–´ ì§ˆì˜ â†’ domain ë¬¸ì„œ hit"""
        ...
```

### Phase 4: Production Ready (í™•ì¥)

**ì¦ë¶„ ì¸ë±ì‹± ê³ ë„í™”**
- ChunkRefreshResult ê¸°ë°˜ íŒŒì¼ ë‹¨ìœ„ ì¬ì¸ë±ì‹±
- Zoekt delta index ì „ëµ (ì˜µì…˜ B)
- GraphDelta ê¸°ë°˜ Symbol Index ì¦ë¶„ ì—…ë°ì´íŠ¸

**Runtime Index (Phase 3+)**
- OpenTelemetry trace â†’ symbol_id ë§¤í•‘
- hot_score, error_score ê³„ì‚°
- Weighted fusionì— runtime weight ë°˜ì˜

**Retriever/Agent í†µí•©**
- Context builderì—ì„œ RepoMap subtree í™œìš©
- Call tree ê¸°ë°˜ íƒìƒ‰
- "ì´ ê¸°ëŠ¥ ì–´ë””ì„œ ì‹œì‘?" â†’ entrypoint ì¶”ì 

---

## 4. ì„¸ë¶€ êµ¬í˜„ í•­ëª© ì²´í¬ë¦¬ìŠ¤íŠ¸

### 4.1 Phase 1 ì²´í¬ë¦¬ìŠ¤íŠ¸ (MVP)

#### Week 1
- [ ] **Ports ì •ì˜** (src/ports.py)
  - [ ] LexicalIndexPort
  - [ ] VectorIndexPort
  - [ ] SymbolIndexPort
  - [ ] FuzzyIndexPort
  - [ ] DomainMetaIndexPort
  - [ ] RuntimeIndexPort

- [ ] **ChunkStore í™•ì¥**
  - [ ] find_chunk_by_file_and_line() ë©”ì„œë“œ êµ¬í˜„
  - [ ] DB Migration: idx_chunks_file_span ì¸ë±ìŠ¤ ì¶”ê°€
  - [ ] ìš°ì„ ìˆœìœ„ ë¡œì§ (function > class > file)
  - [ ] ë§¤í•‘ ì‹¤íŒ¨ fallback ì „ëµ

- [ ] **Snapshot ë©”íƒ€ êµ¬ì¡°**
  - [ ] lexical_index_snapshots í…Œì´ë¸” ìƒì„±
  - [ ] lexical_index_jobs í…Œì´ë¸” ìƒì„±
  - [ ] is_ready í”Œë˜ê·¸ ê´€ë¦¬ ë¡œì§

- [ ] **Helper ìœ í‹¸**
  - [ ] QueryBuilder (build_zoekt_query)
  - [ ] RepoPathResolver (repo_id â†” fs_path â†” zoekt_name)

#### Week 2
- [ ] **Zoekt Adapter**
  - [ ] ZoektLexicalIndex êµ¬í˜„
  - [ ] reindex_repo (subprocess: zoekt-index)
  - [ ] search (Zoekt HTTP API â†’ ChunkStore ë§¤í•‘)
  - [ ] _zoekt_http_search (Zoekt API ì—°ë™)
  - [ ] ë§¤í•‘ ì‹¤íŒ¨ fallback (3ë‹¨ê³„: ì •í™•â†’íŒŒì¼â†’ê°€ìƒ)
  - [ ] delete_repo

- [ ] **Qdrant Adapter**
  - [ ] QdrantVectorIndex êµ¬í˜„
  - [ ] index (collection ìƒì„± + embedding + upsert)
  - [ ] upsert (ì¦ë¶„ ì—…ë°ì´íŠ¸)
  - [ ] delete
  - [ ] search (query embedding â†’ Qdrant search)
  - [ ] ë°°ì¹˜ ì²˜ë¦¬ (256ê°œ ë‹¨ìœ„)

### 4.2 Phase 2 ì²´í¬ë¦¬ìŠ¤íŠ¸ (Quality)

#### Week 3
- [ ] **Unit Tests**
  - [ ] ChunkStore.find_chunk_by_file_and_line í…ŒìŠ¤íŠ¸
  - [ ] ZoektLexicalIndex í…ŒìŠ¤íŠ¸
  - [ ] QdrantVectorIndex í…ŒìŠ¤íŠ¸
  - [ ] QueryBuilder í…ŒìŠ¤íŠ¸

- [ ] **Integration Tests**
  - [ ] E2E: Git repo â†’ Zoekt â†’ ChunkStore â†’ SearchHit
  - [ ] Usecase ê²€ì¦ (C1, C4, B1, E1, E4)

- [ ] **ì„±ëŠ¥ íŠœë‹**
  - [ ] Zoekt ê²€ìƒ‰ latency ì¸¡ì • (p95 < 500ms)
  - [ ] Chunk ë§¤í•‘ ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§ (< 5%)
  - [ ] DB ì¿¼ë¦¬ ìµœì í™”
  - [ ] Metrics ì¶”ê°€

### 4.3 Phase 3 ì²´í¬ë¦¬ìŠ¤íŠ¸ (í™•ì¥)

#### Week 4
- [ ] **Symbol Index**
  - [ ] KuzuSymbolIndex êµ¬í˜„
  - [ ] go-to-definition ì¿¼ë¦¬
  - [ ] find-references ì¿¼ë¦¬
  - [ ] import/use relations

- [ ] **Fuzzy Index**
  - [ ] PostgresFuzzyIndex êµ¬í˜„
  - [ ] trigram ê¸°ë°˜ ê²€ìƒ‰
  - [ ] identifier/symbol_name/file_path fuzzy match

#### Week 5
- [ ] **Domain Meta Index**
  - [ ] DomainMetaIndex êµ¬í˜„
  - [ ] README/ADR/Spec ì¸ë±ì‹±
  - [ ] ë³„ë„ Qdrant collection ê´€ë¦¬

---

## 5. í…ŒìŠ¤íŠ¸ ì „ëµ

### 5.1 Unit Test ë²”ìœ„

**Transformer**
- [x] chunk_to_index_document ë³€í™˜
- [x] RepoMap score í†µí•©
- [x] Parent-child tags

**ChunkStore**
- [ ] find_chunk_by_file_and_line ì •í™•ë„
- [ ] ìš°ì„ ìˆœìœ„ ë¡œì§ (function > class > file)
- [ ] ë§¤í•‘ ì‹¤íŒ¨ fallback

**Zoekt Adapter**
- [ ] reindex_repo (mock subprocess)
- [ ] search (mock Zoekt HTTP API)
- [ ] ë§¤í•‘ ì‹¤íŒ¨ 3ë‹¨ê³„ fallback

**Qdrant Adapter**
- [ ] index (mock Qdrant client)
- [ ] search (mock embedding provider)
- [ ] ë°°ì¹˜ ì²˜ë¦¬

### 5.2 Integration Test ì‹œë‚˜ë¦¬ì˜¤

**E2E í”Œë¡œìš°**
```python
def test_lexical_search_e2e():
    # 1. Git repo ì¤€ë¹„ (ì‘ì€ í…ŒìŠ¤íŠ¸ ë ˆí¬)
    # 2. Chunk ìƒì„± (ChunkBuilder)
    # 3. Zoekt ì¸ë±ì‹± (ZoektLexicalIndex.reindex_repo)
    # 4. ê²€ìƒ‰ (ZoektLexicalIndex.search)
    # 5. ê²€ì¦:
    #    - SearchHit.chunk_idê°€ ì‹¤ì œ Chunkì™€ ì¼ì¹˜
    #    - ë§¤í•‘ ì‹¤íŒ¨ìœ¨ < 5%
    #    - p95 latency < 500ms
```

**Usecase ê²€ì¦**
- [C1] í•¨ìˆ˜ ì •ì˜ ê²€ìƒ‰: `def HybridRetriever.retrieve` â†’ ì •í™•í•œ chunk ë°˜í™˜
- [C4] Identifier ê²€ìƒ‰: `HybridRetriever` â†’ ì •ì˜ + ì£¼ìš” ì°¸ì¡° ë°˜í™˜
- [B1] ë¬¸ìì—´ ê²€ìƒ‰: `"error_code"` â†’ ëª¨ë“  ì¶œí˜„ ìœ„ì¹˜ ë°˜í™˜
- [E1] ì¸ë±ìŠ¤ ë¶€ì¬: is_ready=False â†’ ëª…í™•í•œ ìƒíƒœ ì½”ë“œ ë°˜í™˜
- [E4] ë™ì¼ ì´ë¦„ ì‹¬ë³¼: `parse()` 10ê°œ â†’ file_pathë¡œ êµ¬ë¶„

### 5.3 ì„±ëŠ¥ ëª©í‘œ

| ì§€í‘œ | ëª©í‘œ (Phase 1) | ì¸¡ì • ë°©ë²• |
|------|---------------|----------|
| Lexical ê²€ìƒ‰ latency | p95 < 500ms | E2E íƒ€ì´ë¨¸ |
| Chunk ë§¤í•‘ ì‹¤íŒ¨ìœ¨ | < 5% | (ë§¤í•‘ ì‹¤íŒ¨) / (ì´ ê²°ê³¼) |
| Vector ê²€ìƒ‰ latency | p95 < 2s | E2E íƒ€ì´ë¨¸ |
| Qdrant upsert (1K vectors) | < 2s | ë°°ì¹˜ upsert íƒ€ì´ë¨¸ |

---

## 6. ìœ„í—˜ ìš”ì†Œ ë° ì™„í™” ì „ëµ

### 6.1 High Risk

| ìœ„í—˜ | ì˜í–¥ | ì™„í™” ì „ëµ |
|------|------|----------|
| **Zoekt API/Delta ì´í•´ ë¶€ì¡±** | High | - Sourcegraph ì†ŒìŠ¤ ë¶„ì„<br>- ì´ˆê¸°ì—ëŠ” full reindexë§Œ ì‚¬ìš©<br>- DeltaëŠ” Phase 2ì—ì„œ ì¶”ê°€ |
| **Chunk ë§¤í•‘ ì‹¤íŒ¨ìœ¨ ì¦ê°€** | High | - ChunkStore span ì •í™•ë„ ê°œì„ <br>- 3ë‹¨ê³„ fallback ì „ëµ<br>- ë§¤í•‘ ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§ (< 5%) |
| **snapshot ë™ê¸°í™” ì‹¤íŒ¨** | High | - snapshot_id ì—”ì§„ ê³µí†µí™”<br>- lexical_index_snapshots.is_ready í”Œë˜ê·¸<br>- ì¸ë±ì‹± ì™„ë£Œ í›„ì—ë§Œ ê²€ìƒ‰ í—ˆìš© |

### 6.2 Medium Risk

| ìœ„í—˜ | ì˜í–¥ | ì™„í™” ì „ëµ |
|------|------|----------|
| **ëŒ€í˜• ë ˆí¬ ì¸ë±ì‹± ë¹„ìš©** | Medium | - Nightly ì¸ë±ì‹±<br>- ìš°ì„ ìˆœìœ„ ë ˆí¬ë§Œ ì‹¤ì‹œê°„ ì²˜ë¦¬<br>- Phase 2ì—ì„œ delta index ë„ì… |
| **Span Drift** | Medium | - ChunkIncrementalRefresher ê³ ë„í™”<br>- stable_symbol_id + content_hash ì •ì±…<br>- ì£¼ê¸°ì  full rebuild |
| **Embedding API ë¹„ìš©** | Medium | - ë°°ì¹˜ ì²˜ë¦¬ (256ê°œ ë‹¨ìœ„)<br>- ìºì‹± ì „ëµ (ë™ì¼ content_hash)<br>- Rate limiting |

---

## 7. ì°¸ì¡° ë¬¸ì„œ ë° ì½”ë“œ

### 7.1 ì„¤ê³„ ë¬¸ì„œ
- [00.Overview.md](00.Overview.md) - ì „ì²´ ì•„í‚¤í…ì²˜
- [01.Chunk_to_IndexDocument_Lexical.md](01.Chunk_to_IndexDocument_Lexical.md) - Zoekt êµ¬í˜„ ê°€ì´ë“œ
- [02.usecase](02.usecase) - ì „ì²´ ìœ ì¦ˆì¼€ì´ìŠ¤
- [03.Implementation_Strategy.md](03.Implementation_Strategy.md) - êµ¬í˜„ ì „ëµ
- [../ì¸ë±ì‹±ì „ëµ.md](../ì¸ë±ì‹±ì „ëµ.md) - ì„¸ë¶€ ì„¤ê³„ ëª…ì„¸

### 7.2 í˜„ì¬ êµ¬í˜„
- [src/index/common/documents.py](../../src/index/common/documents.py) - IndexDocument, SearchHit
- [src/index/common/transformer.py](../../src/index/common/transformer.py) - Transformer
- [src/index/service.py](../../src/index/service.py) - IndexingService
- [tests/index/test_transformer.py](../../tests/index/test_transformer.py) - í…ŒìŠ¤íŠ¸

### 7.3 êµ¬í˜„ ëŒ€ìƒ
- [src/ports.py](../../src/ports.py) - Ports ì¶”ê°€
- [src/index/lexical/adapter_zoekt.py](../../src/index/lexical/) - Zoekt Adapter
- [src/index/vector/adapter_qdrant.py](../../src/index/vector/) - Qdrant Adapter
- [src/foundation/chunk/store.py](../../src/foundation/chunk/store.py) - ChunkStore í™•ì¥

---

## 8. ë‹¤ìŒ ë‹¨ê³„ (Immediate Actions)

### 8.1 ë‹¨ê¸° (ì´ë²ˆ ì£¼)
1. **Ports ì •ì˜** (1ì‹œê°„)
   - src/ports.pyì— 6ê°œ Port ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€

2. **ChunkStore í™•ì¥** (2ì‹œê°„)
   - find_chunk_by_file_and_line() êµ¬í˜„
   - DB Migration ì‘ì„±

3. **Snapshot ë©”íƒ€ êµ¬ì¡°** (2ì‹œê°„)
   - lexical_index_snapshots í…Œì´ë¸”
   - lexical_index_jobs í…Œì´ë¸”

### 8.2 ì¤‘ê¸° (ë‹¤ìŒ ì£¼)
4. **Zoekt Adapter** (1-2ì¼)
   - ZoektLexicalIndex êµ¬í˜„
   - ê¸°ë³¸ reindex_repo, search ë™ì‘

5. **Qdrant Adapter** (1-2ì¼)
   - QdrantVectorIndex êµ¬í˜„
   - ê¸°ë³¸ index, search ë™ì‘

6. **í†µí•© í…ŒìŠ¤íŠ¸** (1ì¼)
   - E2E í”Œë¡œìš° ê²€ì¦
   - Usecase C1, C4, B1 ê²€ì¦

### 8.3 ì¥ê¸° (Phase 2-3)
7. **Symbol/Fuzzy/Domain Adapter** (2ì£¼)
8. **ì¦ë¶„ ì¸ë±ì‹± ê³ ë„í™”** (1-2ì£¼)
9. **Runtime Index** (Phase 3+)

---

## 9. ìš”ì•½

**í˜„ì¬ ì™„ì„±ë„**:
- Foundation Layer: 100%
- Index Core (ìŠ¤í‚¤ë§ˆ/ë³€í™˜ê¸°): 100%
- Index Adapters: 0%
- **ì „ì²´: ì•½ 60%**

**MVP ë‹¬ì„± ê¸°ì¤€** (Phase 1-2 ì™„ë£Œ):
- Lexical(Zoekt) + Vector(Qdrant) ê¸°ë³¸ ë™ì‘
- Usecase C1, C4, B1, E1, E4 í†µê³¼
- ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„± (latency, ë§¤í•‘ ì‹¤íŒ¨ìœ¨)

**Production Ready** (Phase 3 ì™„ë£Œ):
- 6ê°œ ì¸ë±ìŠ¤ ëª¨ë‘ ë™ì‘
- ì¦ë¶„ ì¸ë±ì‹± ì§€ì›
- ëª¨ë‹ˆí„°ë§/ì•Œë¦¼ ì™„ë¹„

**ìµœìš°ì„  ì‘ì—…**:
1. Ports ì •ì˜ (1ì‹œê°„)
2. ChunkStore í™•ì¥ (2ì‹œê°„)
3. Zoekt Adapter (1-2ì¼)
4. Qdrant Adapter (1-2ì¼)
