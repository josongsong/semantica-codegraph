# Agent Mode FSM - Quick Start Plan

**ëª©í‘œ**: Phase 0 Week 1 ì™„ë£Œ (Context Navigation + Implementation)
**ê¸°ê°„**: 5ì¼

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

### êµ¬í˜„í•  ê²ƒ
1. **FSM ì—”ì§„** - ëª¨ë“œ ì „í™˜ ê´€ë¦¬
2. **Context Navigation Mode** - ì½”ë“œ íƒìƒ‰
3. **Implementation Mode** - ì½”ë“œ ìƒì„±

### ì‚¬ìš©í•  ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸
- âœ… GraphDocument (Kuzu ì €ì¥)
- âœ… 5-way Hybrid Search
- âœ… Symbol Index
- âœ… Intent Classifier

---

## ğŸ“… Day-by-Day Plan

### **Day 1: FSM ê¸°ë°˜ êµ¬ì¡°** (ì˜¤ëŠ˜)

#### 1ë‹¨ê³„: ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
```bash
mkdir -p src/agent/modes
mkdir -p src/agent/intent
mkdir -p tests/agent
```

#### 2ë‹¨ê³„: í•µì‹¬ íƒ€ì… ì •ì˜ (`src/agent/types.py`)
```python
from enum import Enum
from dataclasses import dataclass, field
from typing import Optional, Any

class AgentMode(str, Enum):
    IDLE = "idle"
    CONTEXT_NAV = "context_navigation"
    IMPLEMENTATION = "implementation"
    DEBUG = "debug"
    TEST = "test"

class ApprovalLevel(str, Enum):
    LOW = "low"      # ì½ê¸°ë§Œ ìë™
    MEDIUM = "medium"  # ì½ê¸° + ì„¤ê³„ ìë™
    HIGH = "high"    # ì½ê¸° + ì„¤ê³„ + ìˆ˜ì • ìë™
    CRITICAL = "critical"  # ìœ„í—˜ ì‘ì—…ì€ í•­ìƒ ìŠ¹ì¸

@dataclass
class Task:
    query: str
    intent: Optional[str] = None
    files: list[str] = field(default_factory=list)

@dataclass
class Result:
    mode: AgentMode
    data: Any
    trigger: Optional[str] = None
    explanation: str = ""
    requires_approval: bool = False

@dataclass
class ModeContext:
    current_files: list[str] = field(default_factory=list)
    current_symbols: list[str] = field(default_factory=list)
    mode_history: list[AgentMode] = field(default_factory=list)
    pending_changes: list = field(default_factory=list)
```

#### 3ë‹¨ê³„: FSM ì—”ì§„ (`src/agent/fsm.py`)
```python
from src.agent.types import AgentMode, ModeContext, Task, Result
from typing import Protocol
import logging

logger = logging.getLogger(__name__)

class ModeHandler(Protocol):
    async def enter(self, context: ModeContext) -> None: ...
    async def execute(self, task: Task, context: ModeContext) -> Result: ...
    async def exit(self, context: ModeContext) -> None: ...

class AgentFSM:
    def __init__(self):
        self.current_mode = AgentMode.IDLE
        self.context = ModeContext()
        self.handlers: dict[AgentMode, ModeHandler] = {}

    def register(self, mode: AgentMode, handler: ModeHandler):
        self.handlers[mode] = handler

    async def transition(self, to_mode: AgentMode):
        logger.info(f"Transition: {self.current_mode} â†’ {to_mode}")

        # Exit current
        if handler := self.handlers.get(self.current_mode):
            await handler.exit(self.context)

        # Transition
        old_mode = self.current_mode
        self.current_mode = to_mode
        self.context.mode_history.append(to_mode)

        # Enter new
        if handler := self.handlers.get(to_mode):
            await handler.enter(self.context)

    async def execute(self, task: Task) -> Result:
        handler = self.handlers.get(self.current_mode)
        if not handler:
            raise ValueError(f"No handler for {self.current_mode}")

        result = await handler.execute(task, self.context)

        # Auto transition
        if result.trigger == "target_found":
            await self.transition(AgentMode.IMPLEMENTATION)
        elif result.trigger == "code_complete":
            await self.transition(AgentMode.TEST)

        return result
```

**ì†Œìš” ì‹œê°„**: 2ì‹œê°„

---

### **Day 2: Context Navigation Mode**

#### êµ¬í˜„ (`src/agent/modes/context_nav.py`)
```python
from src.agent.types import ModeContext, Task, Result, AgentMode
from src.retriever.service import RetrieverService
from src.index.symbol.adapter_kuzu import KuzuSymbolIndex

class ContextNavigationMode:
    def __init__(
        self,
        retriever: RetrieverService,
        symbol_index: KuzuSymbolIndex,
    ):
        self.retriever = retriever
        self.symbol_index = symbol_index

    async def enter(self, context: ModeContext):
        print("ğŸ“ Entering Context Navigation Mode")

    async def execute(self, task: Task, context: ModeContext) -> Result:
        # 1. Hybrid search
        results = await self.retriever.search(
            query=task.query,
            top_k=10,
        )

        # 2. Update context
        for result in results:
            if result.file_path not in context.current_files:
                context.current_files.append(result.file_path)

        # 3. Return
        trigger = "target_found" if results else None

        return Result(
            mode=AgentMode.CONTEXT_NAV,
            data=results,
            trigger=trigger,
            explanation=f"Found {len(results)} relevant chunks",
        )

    async def exit(self, context: ModeContext):
        print(f"ğŸ“ Exiting Context Navigation (found {len(context.current_files)} files)")
```

#### í…ŒìŠ¤íŠ¸ (`tests/agent/test_context_nav.py`)
```python
import pytest
from src.agent.fsm import AgentFSM
from src.agent.modes.context_nav import ContextNavigationMode
from src.agent.types import AgentMode, Task

@pytest.mark.asyncio
async def test_context_navigation():
    # Setup
    fsm = AgentFSM()
    mode = ContextNavigationMode(retriever=..., symbol_index=...)
    fsm.register(AgentMode.CONTEXT_NAV, mode)

    # Transition
    await fsm.transition(AgentMode.CONTEXT_NAV)

    # Execute
    task = Task(query="find login function")
    result = await fsm.execute(task)

    # Assert
    assert len(result.data) > 0
    assert result.trigger == "target_found"
    assert len(fsm.context.current_files) > 0
```

**ì†Œìš” ì‹œê°„**: 4ì‹œê°„

---

### **Day 3: Implementation Mode (ê¸°ë³¸)**

#### êµ¬í˜„ (`src/agent/modes/implementation.py`)
```python
from src.agent.types import ModeContext, Task, Result, AgentMode
from src.infra.llm.openai import OpenAIClient

class ImplementationMode:
    def __init__(self, llm: OpenAIClient):
        self.llm = llm

    async def enter(self, context: ModeContext):
        print("ğŸ”¨ Entering Implementation Mode")
        print(f"   Working on: {context.current_files}")

    async def execute(self, task: Task, context: ModeContext) -> Result:
        # 1. Get related code from context
        code_context = self._build_context(context)

        # 2. Generate code
        prompt = f"""
Task: {task.query}

Related code:
{code_context}

Generate the implementation:
"""
        response = await self.llm.generate(prompt)

        # 3. Parse response (simplified)
        generated_code = self._parse_llm_response(response)

        # 4. Create change
        change = {
            "file": context.current_files[0] if context.current_files else "new_file.py",
            "content": generated_code,
            "action": "add",
        }
        context.pending_changes.append(change)

        return Result(
            mode=AgentMode.IMPLEMENTATION,
            data={"code": generated_code, "changes": [change]},
            trigger="code_complete",
            explanation=f"Generated code for {task.query}",
            requires_approval=True,  # Always require approval for code changes
        )

    def _build_context(self, context: ModeContext) -> str:
        # TODO: Read actual files
        return "\n\n".join(f"# File: {f}" for f in context.current_files)

    def _parse_llm_response(self, response: str) -> str:
        # TODO: Parse code blocks
        return response

    async def exit(self, context: ModeContext):
        print(f"ğŸ”¨ Exiting Implementation ({len(context.pending_changes)} changes)")
```

**ì†Œìš” ì‹œê°„**: 4ì‹œê°„

---

### **Day 4: í†µí•© & Human-in-the-Loop**

#### Orchestrator (`src/agent/orchestrator.py`)
```python
from src.agent.fsm import AgentFSM
from src.agent.modes.context_nav import ContextNavigationMode
from src.agent.modes.implementation import ImplementationMode
from src.agent.types import AgentMode, Task
from src.container import Container

class AgentOrchestrator:
    """Agent ì „ì²´ ì¡°ìœ¨"""

    def __init__(self, container: Container):
        self.fsm = AgentFSM()
        self.container = container

        # Register modes
        self.fsm.register(
            AgentMode.CONTEXT_NAV,
            ContextNavigationMode(
                retriever=container.retriever_service,
                symbol_index=container.symbol_index,
            ),
        )

        self.fsm.register(
            AgentMode.IMPLEMENTATION,
            ImplementationMode(llm=container.llm_client),
        )

    async def execute_task(self, user_query: str) -> dict:
        """ì‚¬ìš©ì ì¿¼ë¦¬ ì‹¤í–‰"""

        # 1. Classify intent
        intent = self._classify_intent(user_query)

        # 2. Start in appropriate mode
        start_mode = self._select_start_mode(intent)
        await self.fsm.transition(start_mode)

        # 3. Execute
        task = Task(query=user_query, intent=intent)
        result = await self.fsm.execute(task)

        # 4. Human approval if needed
        if result.requires_approval:
            approved = await self._request_approval(result)
            if not approved:
                return {"status": "rejected", "result": result}

        # 5. Apply changes
        if self.fsm.context.pending_changes:
            await self._apply_changes(self.fsm.context.pending_changes)

        return {
            "status": "success",
            "result": result,
            "context": self.fsm.context,
        }

    def _classify_intent(self, query: str) -> str:
        # TODO: Use intent classifier
        if "ì°¾" in query or "where" in query.lower():
            return "search"
        elif "ë§Œë“¤" in query or "add" in query.lower():
            return "implement"
        return "unknown"

    def _select_start_mode(self, intent: str) -> AgentMode:
        if intent == "search":
            return AgentMode.CONTEXT_NAV
        elif intent == "implement":
            return AgentMode.IMPLEMENTATION
        return AgentMode.CONTEXT_NAV  # Default

    async def _request_approval(self, result: Result) -> bool:
        # TODO: Real approval UI
        print("\n=== Approval Required ===")
        print(f"Changes: {result.data}")
        print("========================\n")
        response = input("Approve? (y/n): ")
        return response.lower() == "y"

    async def _apply_changes(self, changes: list):
        # TODO: Real file writing
        print(f"\nâœ… Applied {len(changes)} changes")
```

#### E2E í…ŒìŠ¤íŠ¸ (`tests/agent/test_e2e.py`)
```python
import pytest
from src.agent.orchestrator import AgentOrchestrator
from src.container import Container

@pytest.mark.asyncio
async def test_find_and_implement():
    """
    Scenario: "User í´ë˜ìŠ¤ì— validate_email ë©”ì„œë“œ ì¶”ê°€í•´ì¤˜"

    Expected flow:
    1. CONTEXT_NAV: User í´ë˜ìŠ¤ ì°¾ê¸°
    2. IMPLEMENTATION: validate_email ë©”ì„œë“œ ìƒì„±
    3. Approval ìš”ì²­
    4. íŒŒì¼ ì ìš©
    """
    container = Container()  # DI container
    orchestrator = AgentOrchestrator(container)

    # Execute
    result = await orchestrator.execute_task(
        "User í´ë˜ìŠ¤ì— validate_email ë©”ì„œë“œ ì¶”ê°€í•´ì¤˜"
    )

    # Verify
    assert result["status"] == "success"
    assert "validate_email" in str(result["result"].data)
```

**ì†Œìš” ì‹œê°„**: 4ì‹œê°„

---

### **Day 5: ë¬¸ì„œí™” & ë°ëª¨**

#### 1. README ì‘ì„± (`src/agent/README.md`)
```markdown
# Semantica Agent

## Quick Start

```python
from src.agent.orchestrator import AgentOrchestrator
from src.container import Container

# Initialize
container = Container()
agent = AgentOrchestrator(container)

# Execute task
result = await agent.execute_task("find login function")
```

## Modes

- **Context Navigation**: Find code in codebase
- **Implementation**: Generate code
- **Debug**: Fix errors (coming soon)
- **Test**: Generate tests (coming soon)
```

#### 2. ë°ëª¨ ìŠ¤í¬ë¦½íŠ¸ (`examples/agent_demo.py`)
```python
import asyncio
from src.agent.orchestrator import AgentOrchestrator
from src.container import Container

async def main():
    container = Container()
    agent = AgentOrchestrator(container)

    # Demo 1: Find code
    print("\n=== Demo 1: Find login function ===")
    result1 = await agent.execute_task("find login function")
    print(f"Found: {len(result1['result'].data)} results")

    # Demo 2: Implement feature
    print("\n=== Demo 2: Add validate_email method ===")
    result2 = await agent.execute_task("Add validate_email method to User class")
    print(f"Changes: {result2['result'].data}")

if __name__ == "__main__":
    asyncio.run(main())
```

**ì†Œìš” ì‹œê°„**: 2ì‹œê°„

---

## âœ… Week 1 ì™„ë£Œ ê¸°ì¤€

### ê¸°ëŠ¥
- [x] FSM ì—”ì§„ ë™ì‘
- [x] Context Navigation ì‹¤í–‰
- [x] Implementation ì‹¤í–‰
- [x] ëª¨ë“œ ìë™ ì „í™˜
- [x] Human-in-the-Loop

### í…ŒìŠ¤íŠ¸
- [x] Context Navigation ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [x] Implementation ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [x] E2E ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

### ë¬¸ì„œ
- [x] README
- [x] ë°ëª¨ ìŠ¤í¬ë¦½íŠ¸

---

## ğŸš€ ì‹œì‘í•˜ê¸°

```bash
# 1. ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p src/agent/modes
mkdir -p tests/agent

# 2. Day 1 íŒŒì¼ ìƒì„±
touch src/agent/types.py
touch src/agent/fsm.py

# 3. ì½”ë“œ ì‘ì„± ì‹œì‘!
```

---

**ì‘ì„±ì¼**: 2024-11-25
**ì˜ˆìƒ ì™„ë£Œ**: 2024-11-29
