1. ì „ì²´ ë¬¸ì„œ ê²€í†  ìš”ì•½
1.1 ë¬¸ì„œ êµ¬ì¡° ë° ì¼ê´€ì„±
ë¬¸ì„œ	ìƒíƒœ	í•µì‹¬ ë‚´ìš©
00.Overview.md	âœ… ìµœì‹ 	Zoekt ê¸°ë°˜ ì „ì²´ ì•„í‚¤í…ì²˜
01.Chunk_to_IndexDocument_Lexical.md	âœ… ìµœì‹ 	Zoekt Hybrid êµ¬í˜„ ìƒì„¸ ê°€ì´ë“œ
02.usecase	âœ… ì™„ë£Œ	í•µì‹¬/ë² ì´ìŠ¤/ì—£ì§€ì¼€ì´ìŠ¤ ì „ì²´ ëª©ë¡

ì¼ê´€ì„± í‰ê°€

ëª¨ë“  ë¬¸ì„œê°€ Zoekt ê¸°ë°˜ìœ¼ë¡œ í†µì¼ë¨

IndexDocument, SearchHit ìŠ¤í‚¤ë§ˆ ì¼ì¹˜

snapshot_id ì •ì±…ì„ â€œì—”ì§„ ê³µí†µ snapshotâ€ ê¸°ì¤€ìœ¼ë¡œ í†µì¼ ê°€ëŠ¥í•¨

2. í•µì‹¬ ê¸°ìˆ ì  ê²°ì •ì‚¬í•­ ì¢…í•©
2.1 Lexical Index: Zoekt Hybrid ì „ëµ (í™•ì •)

ì„ íƒ ì´ìœ 

ê¸°ì¡´ ì‚¬ìš© ì¤‘: ì´ë¯¸ Zoekt stub ë° ì¸í”„ë¼ ì¼ë¶€ ì¡´ì¬

SOTA ì„±ëŠ¥: Google/Sourcegraphì—ì„œ ê²€ì¦ëœ ì½”ë“œ ê²€ìƒ‰ ì—”ì§„

ì½”ë“œ íŠ¹í™”: ì •ê·œì‹, trigram, symbol ì¸ë±ì‹± ê°•ì 

Delta ì¸ë±ì‹±: Git ê¸°ë°˜ ì¦ë¶„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥(Phase 2 ëŒ€ìƒ)

Hybrid ì ‘ê·¼ êµ¬ì¡°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Zoekt     â”‚ â”€â”€â”€> â”‚ file + line  â”‚ â”€â”€â”€> â”‚ ChunkStore â”‚
â”‚ (íŒŒì¼ ê²€ìƒ‰) â”‚      â”‚   ê²°ê³¼       â”‚      â”‚ (line ë§¤í•‘) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
                                           SearchHit(chunk_id)


ì¥ì 

Zoektì˜ ê°•ë ¥í•œ íŒŒì¼ ê¸°ë°˜ ê²€ìƒ‰ ì—”ì§„ ê·¸ëŒ€ë¡œ í™œìš©

Chunk ë‹¨ìœ„ ì„¸ë°€í•œ ê²°ê³¼ ì œê³µ (LLM context-friendly)

ê¸°ì¡´ Zoekt ì¸í”„ë¼, Git ë ˆí¬ êµ¬ì¡° ì¬ì‚¬ìš©

ë‹¨ì  ë° ì™„í™”

ì¶”ê°€ DB ì¡°íšŒ í•„ìš” â†’ PostgreSQL ì¸ë±ìŠ¤ ìµœì í™”, find_chunk_by_file_and_line ìµœì  êµ¬í˜„ìœ¼ë¡œ ì™„í™”

ë§¤í•‘ ì‹¤íŒ¨ ê°€ëŠ¥ì„± â†’ ì ìˆ˜/ê²½ê³  ê¸°ë°˜ fallback + ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ê´€ë¦¬

2.2 IndexDocument ì„¤ê³„ (Vector/Domain ìš©ë„ ì „ìš©)

ì¤‘ìš”: IndexDocumentëŠ” Lexical(Zoekt)ì™€ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠìŒ

class IndexDocument(BaseModel):
    # Lexical(Zoekt)ëŠ” Git repo íŒŒì¼ ì›ë³¸ ì¸ë±ì‹±
    # IndexDocumentëŠ” Vector/Domain/Runtime ì¸ë±ìŠ¤ì—ì„œë§Œ ì‚¬ìš©

    repo_id: str
    snapshot_id: str
    chunk_id: str

    content: str  # [SUMMARY] + [SIGNATURE] + [CODE] + [META]
    content_vector: list[float] | None  # Vectorìš© (Phase 2)
    identifiers: list[str]
    tags: dict[str, str]
    importance_score: float


ì„¤ê³„ ì›ì¹™

ë¶„ë¦¬ ëª…í™•í™”

Lexical = Zoekt (íŒŒì¼ ì›ë³¸)

Vector/Domain = IndexDocument

ì¬ì‚¬ìš©ì„±

Vector, Domain, Runtime, Symbol rerank ë“± semantic ê³„ì¸µì—ì„œ ëª¨ë‘ ê³µìœ 

í™•ì¥ì„±

content_vector ì¶”ê°€ë¡œ Phase 2 Embedding ì¸ë±ìŠ¤ ë°”ë¡œ ì–¹ì„ ìˆ˜ ìˆê²Œ ì„¤ê³„

ì¶”ê°€: LexicalIndexPort ê³„ì•½

class LexicalSearchHit(BaseModel):
    file_path: str
    line: int
    context: str
    score: float
    is_virtual: bool = False
    chunk_id: str | None = None


class LexicalIndexPort(Protocol):
    def search(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 200,
    ) -> list[LexicalSearchHit]:
        ...

    def reindex_repo(
        self,
        repo_id: str,
        snapshot_id: str,
    ) -> None:
        ...

2.3 ChunkStore ì—­í•  í™•ì¥ (line â†’ chunk í—ˆë¸Œ)

í˜„ì¬: ChunkStoreëŠ” chunk CRUD ì¤‘ì‹¬

í•„ìš” ê¸°ëŠ¥ (í™•ì •)

class ChunkStore:
    def find_chunk_by_file_and_line(
        self,
        repo_id: str,
        file_path: str,
        line: int,
    ) -> Chunk | None:
        """
        Zoekt ê²°ê³¼(file+line) â†’ Chunk ë§¤í•‘
        ìš°ì„ ìˆœìœ„: function > class > file
        """


DB ì¸ë±ìŠ¤

CREATE INDEX idx_chunks_file_span
ON chunks (repo_id, file_path, start_line, end_line);

SELECT *
FROM chunks
WHERE repo_id = $1
  AND file_path = $2
  AND start_line <= $3
  AND end_line >= $3
ORDER BY
  CASE kind
    WHEN 'function' THEN 1
    WHEN 'class' THEN 2
    WHEN 'file' THEN 3
    ELSE 4
  END,
  (end_line - start_line) ASC
LIMIT 1;


ì´ ì„¤ê³„ëŠ” Zoekt ì™¸ ë‹¤ë¥¸ Lexical Backend(ripgrep ë“±)ë¥¼ ë¶™ì—¬ë„ ì¬ì‚¬ìš© ê°€ëŠ¥.

3. êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë° ë‹¨ê³„ë³„ ê³„íš
Phase 1: Core Infrastructure (2ì£¼)
Week 1: Foundation

 IndexDocument / SearchHit / LexicalIndexPort ì •ì˜

ìœ„ì¹˜: src/foundation/indexing/models.py

snapshot_id í•„ë“œ í¬í•¨

 Transformer êµ¬í˜„

ìœ„ì¹˜: src/foundation/indexing/transformer.py

chunk_to_index_document()

_build_search_text, _collect_identifiers, _build_tags

 ChunkStore í™•ì¥

find_chunk_by_file_and_line() êµ¬í˜„

PostgreSQL ì¸ë±ìŠ¤ migration (idx_chunks_file_span)

ë§¤í•‘ ì‹¤íŒ¨ fallback ì „ëµ ì •ì˜ ë° í…ŒìŠ¤íŠ¸

 snapshot ë©”íƒ€ êµ¬ì¡° ì •ì˜

lexical_index_snapshots / lexical_index_jobs í…Œì´ë¸” ìƒì„± (12ì¥ì—ì„œ ìƒì„¸)

Week 2: Zoekt Integration

 Zoekt Adapter

ìœ„ì¹˜: src/infra/search/zoekt_adapter.py

Zoekt HTTP/CLI ì—°ë™

RepoPathResolver (repo_id â†’ filesystem / zoekt repo name)

 ZoektLexicalIndex êµ¬í˜„

ìœ„ì¹˜: src/foundation/indexing/lexical.py

reindex_repo(repo_id, snapshot_id)

search(repo_id, snapshot_id, query)

Zoekt ê²°ê³¼ â†’ ChunkStore ë§¤í•‘ + fallback

 IndexingService MVP

ìœ„ì¹˜: src/foundation/indexing/service.py

index_repo_full(repo_id, snapshot_id)

index_repo_incremental(repo_id, snapshot_id) (ë‚´ë¶€ëŠ” full ì¬ì¸ë±ì‹±ìœ¼ë¡œ ì‹œì‘)

Phase 2: Quality & Testing (1ì£¼)

Unit Test

Transformer, ChunkStore, ZoektAdapter, ZoektLexicalIndex

Integration Test

ì‹¤ì œ Git repo + Zoekt + ChunkStore E2E

ì„±ëŠ¥ ì¸¡ì • ë° íŠœë‹

ê²€ìƒ‰ p95 ë ˆì´í„´ì‹œ, ë§¤í•‘ ì‹¤íŒ¨ìœ¨, DB ì¿¼ë¦¬ ì„±ëŠ¥

Phase 3: Vector/Symbol í™•ì¥ (2ì£¼)

Vector Index (Qdrant)

IndexDocument.content_vector í™œìš©

Embedding provider ì—°ë™

Symbol Index (Kuzu Graph)

go-to-def, find-refs ì¿¼ë¦¬

Weighted Fusion

Lexical/Vector/Symbol/RepoMap importance ê¸°ë°˜ RRF/ê°€ì¤‘í•©

4. ì‹¤ì œ êµ¬í˜„ ì‹œ ì£¼ìš” ì´ìŠˆ ë° í•´ê²° ë°©ì•ˆ
4.1 ğŸ”´ Critical Issue 1: Zoekt ì¸ë±ì‹± íŠ¸ë¦¬ê±°/ìƒíƒœ ê´€ë¦¬

ë¬¸ì œ

ZoektëŠ” Git ë ˆí¬ ë‹¨ìœ„ ì¸ë±ì‹±

â€œì–¸ì œ, ì–´ë–¤ snapshot ê¸°ì¤€ìœ¼ë¡œâ€ ì¸ë±ì‹± ë˜ì—ˆëŠ”ì§€ ëª…ì‹œì  ê´€ë¦¬ í•„ìš”

í•´ê²°: snapshot_id ì¼ê´€ì„± + ì „ìš© ë©”íƒ€ í…Œì´ë¸”

ì—”ì§„ snapshot_id ì •ì±…

ì—”ì§„ ì „ì—­ì—ì„œ snapshot_idëŠ” **â€œì†ŒìŠ¤ ê¸°ì¤€â€**ìœ¼ë¡œ í†µì¼

ì˜ˆì‹œ:

commit:abc12345

branch:main@abc12345

workspace:user123@2025-11-24T02:30:00

Zoektìš© ë³„ë„ í¬ë§·({repo}:{commit[:8]}:{timestamp})ì€ ì“°ì§€ ì•Šê³ ,
í•­ìƒ ì—”ì§„ snapshot_idë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•¨.

lexical_index_snapshots í…Œì´ë¸”

CREATE TABLE lexical_index_snapshots (
    repo_id        TEXT NOT NULL,
    snapshot_id    TEXT NOT NULL,   -- ì—”ì§„ snapshot_id (commit:abc12345)
    backend        TEXT NOT NULL,   -- 'zoekt'
    index_version  TEXT NOT NULL,   -- Zoekt ì¸ë±ìŠ¤ ë””ë ‰í† ë¦¬ëª… ë“±
    is_ready       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (repo_id, snapshot_id, backend)
);


ì •ì±…

lexical_index_snapshots.snapshot_idëŠ” í•­ìƒ IR/Graph/RepoMapê³¼ ë™ì¼í•œ snapshotì„ ê°€ë¦¬í‚¨ë‹¤.

Zoekt ì¸ë±ì‹± ì™„ë£Œ í›„ì—ë§Œ is_ready = TRUEë¡œ ë³€ê²½

Retriever/IndexëŠ” is_ready = TRUE snapshotë§Œ ì‚¬ìš©

ì¸ë±ì‹± Job ìƒíƒœ ê´€ë¦¬

CREATE TABLE lexical_index_jobs (
    job_id        TEXT PRIMARY KEY,
    repo_id       TEXT NOT NULL,
    snapshot_id   TEXT NOT NULL,
    backend       TEXT NOT NULL,   -- 'zoekt'
    status        TEXT NOT NULL,   -- PENDING/RUNNING/SUCCESS/FAILED
    log_path      TEXT,
    started_at    TIMESTAMPTZ,
    finished_at   TIMESTAMPTZ
);


indexserver / IndexingServiceì—ì„œ Job ë‹¨ìœ„ë¡œ ì¸ë±ì‹± ìƒíƒœ ì¶”ì 

ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„/ì•ŒëŒ ì—°ê³„ ê°€ëŠ¥

4.2 ğŸ”´ Critical Issue 2: Zoekt ì¸ë±ì‹± ì „ëµ (Full vs Delta)

ì˜µì…˜ A: ì „ì²´ ì¬ì¸ë±ì‹± (MVP ê¶Œì¥)

def index_repo_full(repo_id: str, snapshot_id: str):
    # 1. Chunk/IR/GraphëŠ” ì´ë¯¸ snapshot_id ê¸°ì¤€ìœ¼ë¡œ ì¤€ë¹„
    # 2. Zoekt ì „ì²´ ì¬ì¸ë±ì‹±
    zoekt_backend.reindex_repo(repo_id, snapshot_id)
    lexical_index_snapshot_repo.mark_ready(repo_id, snapshot_id)


ì¥ì : êµ¬í˜„ ë‹¨ìˆœ, ë™ê¸°í™” ì´ìŠˆ ìµœì†Œ

ë‹¨ì : ëŒ€í˜• ë ˆí¬ì—ì„œ ë¹„ìš© ì¦ê°€

ì ìš©: ì´ˆê¸°ì— ëª¨ë“  ë ˆí¬ì—ì„œ ì‚¬ìš©, ë‚˜ì¤‘ì— ê·œëª¨ë³„ ì •ì±… ë¶„ë¦¬

ì˜µì…˜ B: íŒŒì¼ ë‹¨ìœ„ ì¬ì¸ë±ì‹± (Phase 2)

ChunkIncrementalRefresher ê²°ê³¼ì˜ ë³€ê²½ íŒŒì¼ ëª©ë¡ ê¸°ë°˜ìœ¼ë¡œ partial reindex ì‹œë„

Zoektì˜ delta/partial index ì˜µì…˜ ì¡°ì‚¬ í•„ìš”

êµ¬í˜„ ë‚œì´ë„â†‘, ìš´ì˜ ë³µì¡ë„â†‘

ì˜µì…˜ C: ì£¼ê¸°ì  ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹±

ë³„ë„ zoekt-indexserver í”„ë¡œì„¸ìŠ¤ê°€ Git ë³€í™” ê°ì‹œ

SemanticaëŠ” Chunk/IR/Graphë§Œ ê´€ë¦¬, Lexicalì€ ë¹„ë™ê¸° ë°˜ì˜

eventual consistency ëª¨ë¸

ì •ì±…

v1: ì˜µì…˜ Aë§Œ ì§€ì›

v2: ëŒ€í˜• ë ˆí¬ì— ëŒ€í•´ B/C í˜¼í•© ê³ ë ¤

4.3 ğŸ”´ Critical Issue 3: ë§¤í•‘ ì‹¤íŒ¨ ì‹œ Fallback ì „ëµ

ë¬¸ì œ

Zoekt ê²°ê³¼ì˜ (file_path, line)ì— ëŒ€ì‘í•˜ëŠ” Chunkê°€ ì—†ì„ ìˆ˜ ìˆìŒ

Chunk ìƒì„± ì‹¤íŒ¨

Span Drift ë¯¸ë°˜ì˜

Zoekt ì¸ë±ìŠ¤ì™€ Chunk snapshot ë¶ˆì¼ì¹˜

ìš°ì„ ìˆœìœ„ Fallback

ì •í™•í•œ function/class chunk â†’ score 1.0

íŒŒì¼ chunk â†’ score 0.8

ê°€ìƒ chunk_id â†’ score 0.5 + warning

êµ¬í˜„ ì˜ˆì‹œ

def search(self, repo_id: str, snapshot_id: str, query: str, limit: int):
    raw_hits = self._zoekt_search(repo_id, snapshot_id, query)
    hits: list[LexicalSearchHit] = []

    for r in raw_hits:
        chunk = self.chunk_store.find_chunk_by_file_and_line(
            repo_id=repo_id,
            file_path=r.file_path,
            line=r.line,
        )

        if chunk:
            hits.append(LexicalSearchHit(
                file_path=r.file_path,
                line=r.line,
                context=r.context,
                score=r.score,
                chunk_id=chunk.chunk_id,
                is_virtual=False,
            ))
            continue

        file_chunk = self.chunk_store.find_file_chunk(repo_id, r.file_path)
        if file_chunk:
            hits.append(LexicalSearchHit(
                file_path=r.file_path,
                line=r.line,
                context=r.context,
                score=r.score * 0.8,
                chunk_id=file_chunk.chunk_id,
                is_virtual=False,
            ))
        else:
            hits.append(LexicalSearchHit(
                file_path=r.file_path,
                line=r.line,
                context=r.context,
                score=r.score * 0.5,
                chunk_id=f"virtual:{repo_id}:{r.file_path}:{r.line}",
                is_virtual=True,
            ))

    return hits[:limit]


ëª¨ë‹ˆí„°ë§

ë§¤í•‘ ì‹¤íŒ¨ìœ¨ ì¶”ì : ëª©í‘œ < 5%

Metric ì˜ˆì‹œ:

zoekt_mapping_failure_total{repo_id}

zoekt_mapping_failure_by_reason{reason="no_chunk|multi_match|..."}

ì‹¤íŒ¨ìœ¨/ê°€ìƒ chunk ë¹„ìœ¨ì´ ì„ê³„ê°’ ì´ˆê³¼ ì‹œ ì•Œë¦¼

4.4 âš ï¸ Design Decisions (ëª…í™•í™”)

Decision 1: Lexical vs IndexDocument ì—­í•  ë¶„ë¦¬

Lexical(Zoekt): íŒŒì¼ ë‹¨ìœ„, ë¹ ë¥¸ í‚¤ì›Œë“œ/identifier ê²€ìƒ‰

IndexDocument: semantic/ë²¡í„°/ë„ë©”ì¸ ì¸ë±ì‹± ì „ìš©

Symbol: Graph(Kuzu) ê¸°ë°˜

Decision 2: ChunkStoreì— line ë§¤í•‘ ì±…ì„ ë¶€ì—¬

ë³„ë„ â€œChunkMappingServiceâ€ë¥¼ ë‘ëŠ” ëŒ€ì‹ ,

ChunkStoreê°€ span ê¸°ë°˜ ì¡°íšŒê¹Œì§€ ë‹´ë‹¹

ë‹¨ì¼ ì§„ì…ì : find_chunk_by_file_and_line

Decision 3: Usecase ê¸°ë°˜ ê²€ì¦

Phase 1ì—ì„œ ë°˜ë“œì‹œ ë§Œì¡±í•´ì•¼ í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤:

C1: í•¨ìˆ˜/ë©”ì„œë“œ ì •ì˜ ìœ„ì¹˜ ì°¾ê¸°

C4: ì‹¬ë³¼ ì´ë¦„/identifier ê²€ìƒ‰

B1: ë‹¨ìˆœ ë¬¸ìì—´ ê²€ìƒ‰

E1/E4: ì¸ë±ìŠ¤ ë¶€ì¬/ë™ì¼ ì´ë¦„ ì‹¬ë³¼ ë¶„ë¦¬

Zoekt + ChunkStore + snapshot_id ì¡°í•©ìœ¼ë¡œ ì´ 4ê°œë¥¼ ë¨¼ì € ì™„ì„±

5. ì‹¤í–‰ ê³„íš ë° ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì •ë¦¬)

Week 1

Indexing ëª¨ë¸/í¬íŠ¸ ì •ì˜

Transformer êµ¬í˜„

ChunkStore í™•ì¥ + ì¸ë±ìŠ¤ ì¶”ê°€

lexical_index_snapshots / lexical_index_jobs í…Œì´ë¸” ìƒì„±

Week 2

ZoektAdapter + ZoektLexicalIndex êµ¬í˜„

IndexingServiceì—ì„œ full reindex í”Œë¡œìš° ì™„ì„±

Zoekt + ChunkStore E2E í†µí•© í…ŒìŠ¤íŠ¸

Week 3

í…ŒìŠ¤íŠ¸/ì„±ëŠ¥ íŠœë‹

Usecase C1/C4/B1/E1/E4 ê¸°ì¤€ìœ¼ë¡œ í’ˆì§ˆ ê²€ì¦

ë§¤í•‘ ì‹¤íŒ¨ ëª¨ë‹ˆí„°ë§ + fallback íŠœë‹

6. ìœ„í—˜ ìš”ì†Œ ë° ì™„í™” ì „ëµ (ì—…ë°ì´íŠ¸ ë²„ì „)

High Risk

ìœ„í—˜	ì˜í–¥	ì™„í™” ì „ëµ
Zoekt API/Delta ì´í•´ ë¶€ì¡±	High	ì†ŒìŠ¤ ë¶„ì„, Sourcegraph ì‚¬ë¡€ ì°¸ê³ , ì´ˆê¸°ì—ëŠ” full reindexë§Œ ì‚¬ìš©
ë§¤í•‘ ì‹¤íŒ¨ìœ¨ ì¦ê°€	High	ChunkStore span ì„±ëŠ¥/ì •í™•ë„ ê°œì„ , fallback ìŠ¤ì½”ì–´ ì¡°ì •, ëª¨ë‹ˆí„°ë§
snapshot ë™ê¸°í™” ì‹¤íŒ¨	High	snapshot_id ì—”ì§„ ê³µí†µí™”, lexical_index_snapshots/is_ready í”Œë˜ê·¸ ë„ì…

Medium Risk

ìœ„í—˜	ì˜í–¥	ì™„í™” ì „ëµ
ëŒ€í˜• ë ˆí¬ ì¸ë±ì‹± ë¹„ìš©	Medium	nightly ì¸ë±ì‹±, ìš°ì„  ìˆœìœ„ ë ˆí¬ë§Œ ì‹¤ì‹œê°„ ì²˜ë¦¬
Span Drift	Medium	ChunkIncrementalRefresher ê³ ë„í™”, ì£¼ê¸°ì  full rebuild
