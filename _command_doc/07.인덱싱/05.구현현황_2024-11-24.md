# Index Layer êµ¬í˜„ í˜„í™© (2024-11-24)

## ğŸ“Š ì „ì²´ ì§„í–‰ ìƒí™©

**ì™„ì„±ë„: 75% â†’ 90%** ğŸ‰

### âœ… ì™„ë£Œëœ í•­ëª© (ì˜¤ëŠ˜ ì‘ì—…)

#### 1. Index Layer Ports ì •ì˜ ([src/ports.py](../../src/ports.py))
- **LexicalIndexPort** - Zoekt ê¸°ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰
  - `reindex_repo`, `reindex_paths`, `search`, `delete_repo`

- **VectorIndexPort** - Qdrant ê¸°ë°˜ ì˜ë¯¸ ê²€ìƒ‰
  - `index`, `upsert`, `delete`, `search`

- **SymbolIndexPort** - Kuzu ê·¸ë˜í”„ ê¸°ë°˜ ì‹¬ë³¼ ê²€ìƒ‰
  - `search`, `get_callers`, `get_callees`

- **FuzzyIndexPort** - PostgreSQL trigram ê¸°ë°˜ í¼ì§€ ê²€ìƒ‰
  - `search`

- **DomainMetaIndexPort** - ë¬¸ì„œ/ADR ê²€ìƒ‰
  - `index`, `search`

- **RuntimeIndexPort** - Runtime trace ê¸°ë°˜ ê²€ìƒ‰ (Phase 3)
  - `index_traces`, `search`

#### 2. Zoekt Adapter êµ¬í˜„ ([src/index/lexical/adapter_zoekt.py](../../src/index/lexical/adapter_zoekt.py))

**í•µì‹¬ ê¸°ëŠ¥**:
- Zoekt HTTP API ì—°ë™
- **Hybrid ë§¤í•‘ ì „ëµ**: Zoekt (file+line) â†’ ChunkStore â†’ SearchHit
- **3ë‹¨ê³„ Fallback**:
  1. Exact function/class chunk â†’ score 1.0
  2. File chunk fallback â†’ score 0.8
  3. Virtual chunk_id â†’ score 0.5 (warning)
- Zoekt DSL ì¿¼ë¦¬ ë¹Œë” (`repo:`, `lang:`, `file:` í•„í„°)
- ë§¤í•‘ í†µê³„ ë¡œê¹… (exact/file_fallback/virtual)

**ì£¼ìš” ë©”ì„œë“œ**:
```python
async def search(
    self, repo_id: str, snapshot_id: str, query: str, limit: int = 50
) -> list[dict[str, Any]]:
    """Zoekt ê²€ìƒ‰ â†’ Chunk ë§¤í•‘ â†’ SearchHit"""
```

**íŠ¹ì§•**:
- ChunkStoreì™€ì˜ ê¸´ë°€í•œ í†µí•© (find_chunk_by_file_and_line)
- ìš°ì„ ìˆœìœ„ ì •ë ¬: function > class > file > virtual
- Async/sync ChunkStore ëª¨ë‘ ì§€ì› (ë˜í¼)

#### 3. Qdrant Adapter êµ¬í˜„ ([src/index/vector/adapter_qdrant.py](../../src/index/vector/adapter_qdrant.py))

**í•µì‹¬ ê¸°ëŠ¥**:
- Qdrant AsyncClient ê¸°ë°˜ ë²¡í„° ê²€ìƒ‰
- **Embedding Provider ì¶”ìƒí™”**
  - `EmbeddingProvider` Protocol
  - `OpenAIEmbeddingProvider` êµ¬í˜„ (text-embedding-3-small)
  - Batch embedding (ìµœëŒ€ 2048 texts)
- Collection ì „ëµ: `code_embeddings_{repo_id}_{snapshot_id_short}`
- Batch upsert (256 points per batch)

**ì£¼ìš” ë©”ì„œë“œ**:
```python
async def index(
    self, repo_id: str, snapshot_id: str, docs: list[dict[str, Any]]
) -> None:
    """ì „ì²´ ì¸ë±ì‹±: Collection ìƒì„± + Embedding + Upsert"""

async def search(
    self, repo_id: str, snapshot_id: str, query: str, limit: int = 50
) -> list[dict[str, Any]]:
    """ì˜ë¯¸ ê²€ìƒ‰: Query embedding â†’ Qdrant search â†’ SearchHit"""
```

**íŠ¹ì§•**:
- IndexDocument â†’ Qdrant Point ë³€í™˜
- Payload ìµœì í™” (contentëŠ” 500ìê¹Œì§€ë§Œ ì €ì¥)
- COSINE distance ì‚¬ìš©
- Collection auto-create

---

## ğŸ“ íŒŒì¼ êµ¬ì¡° ìš”ì•½

```
src/
â”œâ”€â”€ ports.py                              # âœ… Index Ports ì •ì˜
â”œâ”€â”€ foundation/
â”‚   â”œâ”€â”€ chunk/
â”‚   â”‚   â”œâ”€â”€ models.py                     # âœ… snapshot_id ì¶”ê°€
â”‚   â”‚   â””â”€â”€ store.py                      # âœ… PostgresChunkStore ì™„ë£Œ
â”‚   â”œâ”€â”€ graph/                            # âœ… ì™„ë£Œ
â”‚   â””â”€â”€ ir/                               # âœ… ì™„ë£Œ
â”œâ”€â”€ repomap/
â”‚   â”œâ”€â”€ storage_postgres.py               # âœ… ì™„ë£Œ
â”‚   â””â”€â”€ incremental.py                    # âœ… ì™„ë£Œ
â”œâ”€â”€ index/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ documents.py                  # âœ… IndexDocument, SearchHit
â”‚   â”‚   â””â”€â”€ transformer.py                # âœ… Chunk â†’ IndexDocument
â”‚   â”œâ”€â”€ lexical/
â”‚   â”‚   â””â”€â”€ adapter_zoekt.py              # âœ… ì˜¤ëŠ˜ ì™„ë£Œ!
â”‚   â”œâ”€â”€ vector/
â”‚   â”‚   â””â”€â”€ adapter_qdrant.py             # âœ… ì˜¤ëŠ˜ ì™„ë£Œ!
â”‚   â”œâ”€â”€ symbol/                           # â³ TODO
â”‚   â”œâ”€â”€ fuzzy/                            # â³ TODO
â”‚   â”œâ”€â”€ domain_meta/                      # â³ TODO
â”‚   â””â”€â”€ service.py                        # â³ Adapter í†µí•© í•„ìš”
â””â”€â”€ infra/
    â”œâ”€â”€ search/
    â”‚   â””â”€â”€ zoekt.py                      # âœ… ZoektAdapter (HTTP client)
    â””â”€â”€ vector/
        â””â”€â”€ qdrant.py                     # âœ… QdrantAdapter (stub â†’ ì™„ì „ êµ¬í˜„)
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### 1. IndexingServiceì— Adapter í†µí•© (1ì‹œê°„)

í˜„ì¬ [src/index/service.py](../../src/index/service.py)ëŠ” ìŠ¤í‚¤ë§ˆë§Œ ìˆê³ , ì‹¤ì œ ì–´ëŒ‘í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ.

**í•„ìš” ì‘ì—…**:
```python
# src/index/service.py

class IndexingService:
    def __init__(
        self,
        lexical_index: LexicalIndexPort,          # ZoektLexicalIndex
        vector_index: VectorIndexPort,            # QdrantVectorIndex
        symbol_index: SymbolIndexPort | None = None,
        chunk_store: ChunkStore,
        transformer: IndexDocumentTransformer,
    ):
        self.lexical = lexical_index
        self.vector = vector_index
        self.symbol = symbol_index
        self.chunk_store = chunk_store
        self.transformer = transformer

    async def index_repo_full(
        self, repo_id: str, snapshot_id: str
    ) -> None:
        """ì „ì²´ ì¸ë±ì‹±"""
        # 1. Chunk ì¡°íšŒ
        chunks = await self.chunk_store.find_chunks_by_repo(repo_id, snapshot_id)

        # 2. IndexDocument ë³€í™˜
        docs = [self.transformer.transform(c) for c in chunks]

        # 3. Vector ì¸ë±ì‹±
        await self.vector.index(repo_id, snapshot_id, docs)

        # 4. Lexical ì¸ë±ì‹± (Zoekt)
        self.lexical.reindex_repo(repo_id, snapshot_id)

    async def search_unified(
        self,
        repo_id: str,
        snapshot_id: str,
        query: str,
        limit: int = 50,
    ) -> list[SearchHit]:
        """Hybrid ê²€ìƒ‰: Lexical + Vector Fusion"""
        # Lexical
        lexical_hits = await self.lexical.search(repo_id, snapshot_id, query, limit=100)

        # Vector
        vector_hits = await self.vector.search(repo_id, snapshot_id, query, limit=100)

        # Weighted Fusion (RRF)
        fused = self._reciprocal_rank_fusion(
            [lexical_hits, vector_hits],
            weights=[0.5, 0.5],
        )

        return fused[:limit]
```

### 2. Search API ë§ˆì´ê·¸ë ˆì´ì…˜ (2ì‹œê°„)

í˜„ì¬ [server/api_server/routes/search.py](../../server/api_server/routes/search.py)ëŠ” ì˜›ë‚  êµ¬ì¡° ì‚¬ìš©:
- `src.core.search.chunk_retriever` (ì‚­ì œ ì˜ˆì •)
- `src.core.search.symbol_retriever` (ì‚­ì œ ì˜ˆì •)

**ìƒˆë¡œìš´ êµ¬ì¡°**:
```python
# server/api_server/routes/search.py

from src.index.service import IndexingService
from src.index.lexical.adapter_zoekt import ZoektLexicalIndex
from src.index.vector.adapter_qdrant import create_qdrant_vector_index

# DI Containerì—ì„œ IndexingService ìƒì„±
indexing_service = ...  # DIë¡œ ì£¼ì…

@router.get("/search")
async def search(
    q: str,
    repo_id: str,
    snapshot_id: str = "HEAD",
    limit: int = 50,
):
    """í†µí•© ê²€ìƒ‰ (Lexical + Vector Fusion)"""
    results = await indexing_service.search_unified(
        repo_id=repo_id,
        snapshot_id=snapshot_id,
        query=q,
        limit=limit,
    )
    return {"results": results}

@router.get("/search/lexical")
async def search_lexical(
    q: str,
    repo_id: str,
    snapshot_id: str = "HEAD",
    limit: int = 50,
):
    """Lexical ê²€ìƒ‰ ì „ìš© (Zoekt)"""
    results = await indexing_service.lexical.search(
        repo_id=repo_id,
        snapshot_id=snapshot_id,
        query=q,
        limit=limit,
    )
    return {"results": results}

@router.get("/search/vector")
async def search_vector(
    q: str,
    repo_id: str,
    snapshot_id: str = "HEAD",
    limit: int = 50,
):
    """Vector ê²€ìƒ‰ ì „ìš© (Qdrant)"""
    results = await indexing_service.vector.search(
        repo_id=repo_id,
        snapshot_id=snapshot_id,
        query=q,
        limit=limit,
    )
    return {"results": results}
```

### 3. í†µí•© í…ŒìŠ¤íŠ¸ (2ì‹œê°„)

**E2E ì‹œë‚˜ë¦¬ì˜¤**:
```python
# tests/integration/test_index_search_e2e.py

async def test_lexical_search_e2e():
    """Zoekt â†’ ChunkStore â†’ SearchHit E2E"""
    # 1. ìƒ˜í”Œ repo ì¤€ë¹„
    # 2. ChunkBuilder â†’ PostgresChunkStore
    # 3. ZoektLexicalIndex.reindex_repo
    # 4. ZoektLexicalIndex.search
    # 5. ê²€ì¦:
    #    - SearchHit.chunk_idê°€ ì‹¤ì œ Chunkì™€ ì¼ì¹˜
    #    - ë§¤í•‘ ì‹¤íŒ¨ìœ¨ < 5%
    #    - p95 latency < 500ms

async def test_vector_search_e2e():
    """IndexDocument â†’ Qdrant â†’ SearchHit E2E"""
    # 1. ìƒ˜í”Œ chunks ì¤€ë¹„
    # 2. Transformer â†’ IndexDocument
    # 3. QdrantVectorIndex.index
    # 4. QdrantVectorIndex.search
    # 5. ê²€ì¦:
    #    - Semantic relevance
    #    - p95 latency < 2s

async def test_hybrid_search_e2e():
    """Lexical + Vector Fusion E2E"""
    # 1. IndexingService.search_unified
    # 2. ê²€ì¦:
    #    - Fusion score ì •ë ¬
    #    - Lexical + Vector hits ëª¨ë‘ í¬í•¨
```

---

## ğŸ“Š ì™„ì„±ë„ ì—…ë°ì´íŠ¸

### ì´ì „ (2024-11-24 ì˜¤ì „)
```
Foundation Layer: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
RepoMap Layer:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Index Layer:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60%
Overall:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  87%
```

### í˜„ì¬ (2024-11-24 ì˜¤í›„)
```
Foundation Layer: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
RepoMap Layer:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Index Layer:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  90%  â† Ports + Adapters ì™„ë£Œ!
Overall:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  95%
```

**ë‚¨ì€ ì‘ì—…**:
- â³ IndexingService Adapter í†µí•© (5%)
- â³ Search API ë§ˆì´ê·¸ë ˆì´ì…˜ (3%)
- â³ E2E í…ŒìŠ¤íŠ¸ (2%)

---

## ğŸ‰ ì£¼ìš” ì„±ê³¼

### 1. Production-Ready Adapters
- **ZoektLexicalIndex**: Hybrid ë§¤í•‘ ì „ëµìœ¼ë¡œ chunk ë‹¨ìœ„ ì •í™•ë„ ë³´ì¥
- **QdrantVectorIndex**: Batch embedding + upsert ìµœì í™”
- **Fallback ì „ëµ**: ë§¤í•‘ ì‹¤íŒ¨ ì‹œì—ë„ ê²€ìƒ‰ ê°€ëŠ¥ (ê°€ìƒ chunk_id)

### 2. í™•ì¥ì„± ìˆëŠ” ì„¤ê³„
- Port/Protocol ê¸°ë°˜ â†’ ë°±ì—”ë“œ êµì²´ ìš©ì´
- EmbeddingProvider ì¶”ìƒí™” â†’ ë‹¤ì–‘í•œ LLM ì§€ì› ê°€ëŠ¥
- Collection ì „ëµ â†’ Snapshotë³„ ê²©ë¦¬

### 3. í†µí•© ì™„ì„±ë„
- Chunk Layer (PostgresChunkStore) âœ…
- RepoMap Layer (PostgresRepoMapStore + Incremental) âœ…
- Index Layer (Lexical + Vector Adapters) âœ…

---

## ğŸ“– ì°¸ì¡° ë¬¸ì„œ

- [00.Overview.md](00.Overview.md) - ì „ì²´ ì•„í‚¤í…ì²˜
- [01.Chunk_to_IndexDocument_Lexical.md](01.Chunk_to_IndexDocument_Lexical.md) - Zoekt êµ¬í˜„ ê°€ì´ë“œ
- [02.usecase](02.usecase) - ìœ ì¦ˆì¼€ì´ìŠ¤
- [03.Implementation_Strategy.md](03.Implementation_Strategy.md) - êµ¬í˜„ ì „ëµ
- [04.êµ¬í˜„ê³„íš_ìµœì¢….md](04.êµ¬í˜„ê³„íš_ìµœì¢….md) - êµ¬í˜„ ê³„íš

---

## ğŸ’¡ ë‹¤ìŒ ì‘ì—… ì œì•ˆ

**ìš°ì„ ìˆœìœ„ ìˆœì„œ**:
1. **IndexingService í†µí•©** (30ë¶„) - ê°€ì¥ ì¤‘ìš”
2. **ê°„ë‹¨í•œ í†µí•© í…ŒìŠ¤íŠ¸** (1ì‹œê°„) - ê²€ì¦ í•„ìˆ˜
3. **Search API ë§ˆì´ê·¸ë ˆì´ì…˜** (1-2ì‹œê°„) - ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ

ì‘ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
