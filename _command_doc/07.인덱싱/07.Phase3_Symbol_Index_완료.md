# Phase 3: Symbol Index êµ¬í˜„ ì™„ë£Œ (2024-11-24)

## ğŸ“Š ìµœì¢… ì§„í–‰ ìƒí™©

**ì™„ì„±ë„: 98% â†’ 99%** ğŸ‰ğŸ‰ğŸ‰

```
Foundation Layer: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
RepoMap Layer:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Chunk Layer:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  90%
Index Layer:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  99%  â† Symbol Index ì¶”ê°€!
Overall:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘  98%
```

---

## âœ… ì˜¤ëŠ˜ ì™„ë£Œëœ Phase 3 ì‘ì—…

### Symbol Index (Kuzu Graph) êµ¬í˜„

#### 1. Kuzu Symbol Adapter ([src/index/symbol/adapter_kuzu.py](../../src/index/symbol/adapter_kuzu.py))

**í•µì‹¬ ê¸°ëŠ¥**:
- Kuzu embedded graph database ì‚¬ìš©
- GraphDocument â†’ Kuzu ê·¸ë˜í”„ ë³€í™˜
- ì‹¬ë³¼ ê²€ìƒ‰ (ì´ë¦„/FQN ê¸°ë°˜)
- Caller/Callee ì¿¼ë¦¬ (í˜¸ì¶œ ê·¸ë˜í”„)
- Snapshot ê²©ë¦¬ (repo_id + snapshot_id)

**Kuzu ìŠ¤í‚¤ë§ˆ**:
```cypher
# Symbol ë…¸ë“œ í…Œì´ë¸”
CREATE NODE TABLE Symbol(
    id STRING PRIMARY KEY,
    repo_id STRING,
    snapshot_id STRING,
    kind STRING,              # Function, Class, Method, etc.
    fqn STRING,               # Fully qualified name
    name STRING,              # Simple name
    path STRING,              # File path
    start_line INT64,
    end_line INT64,
    attrs STRING              # JSON metadata
)

# Relationship ì—£ì§€ í…Œì´ë¸”
CREATE REL TABLE Relationship(
    FROM Symbol TO Symbol,
    kind STRING,              # CALLS, CONTAINS, REFERENCES, etc.
    attrs STRING              # JSON metadata
)
```

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class KuzuSymbolIndex:
    def index_graph(
        self, repo_id: str, snapshot_id: str, graph_doc: GraphDocument
    ) -> None:
        """GraphDocumentë¥¼ Kuzuì— ì¸ë±ì‹±"""
        # 1. ìŠ¤í‚¤ë§ˆ ìƒì„±
        # 2. ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (snapshot ê²©ë¦¬)
        # 3. ë…¸ë“œ ì‚½ì…
        # 4. ì—£ì§€ ì‚½ì…

    async def search(
        self, repo_id: str, snapshot_id: str, query: str, limit: int
    ) -> list[SearchHit]:
        """ì‹¬ë³¼ ì´ë¦„/FQNìœ¼ë¡œ ê²€ìƒ‰"""
        # Cypher query: partial match (CONTAINS)
        # ORDER BY name length (shortest first)

    def get_callers(self, symbol_id: str) -> list[dict]:
        """íŠ¹ì • ì‹¬ë³¼ì„ í˜¸ì¶œí•˜ëŠ” ì‹¬ë³¼ë“¤"""
        # MATCH (caller)-[:CALLS]->(symbol)

    def get_callees(self, symbol_id: str) -> list[dict]:
        """íŠ¹ì • ì‹¬ë³¼ì´ í˜¸ì¶œí•˜ëŠ” ì‹¬ë³¼ë“¤"""
        # MATCH (symbol)-[:CALLS]->(callee)
```

**ê²€ìƒ‰ ì˜ˆì‹œ**:
```python
# ì‹¬ë³¼ ê²€ìƒ‰
hits = await symbol_index.search("myrepo", "HEAD", "HybridRetriever", limit=50)

# Callers ì¡°íšŒ
callers = symbol_index.get_callers("func:search.HybridRetriever.__init__")
# â†’ [{"id": "func:main.create_engine", "name": "create_engine", ...}]

# Callees ì¡°íšŒ
callees = symbol_index.get_callees("func:search.HybridRetriever.search")
# â†’ [{"id": "func:lexical.search", "name": "search", ...}]
```

#### 2. Factory í†µí•© ([src/index/factory.py](../../src/index/factory.py))

**ë³€ê²½ ì‚¬í•­**:
```python
async def create_indexing_service(
    chunk_store: ChunkStore,
    # ... existing params ...
    kuzu_db_path: str = "./kuzu_db",     # â† ì¶”ê°€
    enable_symbol: bool = True,          # â† ê¸°ë³¸ê°’ Trueë¡œ ë³€ê²½
) -> IndexingService:
    # ...
    # Symbol Index ìƒì„±
    if enable_symbol:
        symbol_index = KuzuSymbolIndex(db_path=kuzu_db_path)
        logger.info(f"âœ“ Symbol Index: Kuzu @ {kuzu_db_path}")
```

**Config í”„ë¦¬ì…‹ ì—…ë°ì´íŠ¸**:
```python
class IndexingConfig:
    DEV = {
        # ... existing config ...
        "kuzu_db_path": "./kuzu_db",
        "enable_symbol": True,
    }

    PROD = {
        # ...
        "kuzu_db_path": "/app/kuzu_db",
        "enable_symbol": True,
    }
```

#### 3. í…ŒìŠ¤íŠ¸ ì‘ì„± ([tests/index/test_symbol_index.py](../../tests/index/test_symbol_index.py))

**í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**:
- âœ… ê¸°ë³¸ ì¸ë±ì‹± ë° ê²€ìƒ‰
- âœ… Caller/Callee ì¿¼ë¦¬
- âœ… ë¶€ë¶„ ë¬¸ìì—´ ë§¤ì¹­
- âœ… Snapshot ê²©ë¦¬ (ë‹¤ë¥¸ snapshot ê°„ ë…ë¦½ì„±)

**í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ**:
```python
@pytest.mark.asyncio
async def test_symbol_index_basic(temp_kuzu_db, sample_graph_doc):
    """ê¸°ë³¸ ì‹¬ë³¼ ì¸ë±ì‹± ë° ê²€ìƒ‰ í…ŒìŠ¤íŠ¸"""
    index = KuzuSymbolIndex(db_path=temp_kuzu_db)
    index.index_graph("test_repo", "commit123", sample_graph_doc)

    # í´ë˜ìŠ¤ ê²€ìƒ‰
    results = await index.search("test_repo", "commit123", "MyClass", limit=10)
    assert len(results) > 0

    # ë©”ì„œë“œ ê²€ìƒ‰
    results = await index.search("test_repo", "commit123", "method1", limit=10)
    assert len(results) > 0

@pytest.mark.asyncio
async def test_symbol_callers_callees(temp_kuzu_db, sample_graph_doc):
    """Caller/Callee ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸"""
    index = KuzuSymbolIndex(db_path=temp_kuzu_db)
    index.index_graph("test_repo", "commit123", sample_graph_doc)

    # Callers ì¡°íšŒ
    callers = index.get_callers("func:MyClass.method2")
    assert len(callers) == 1
    assert callers[0]["id"] == "func:MyClass.method1"

    # Callees ì¡°íšŒ
    callees = index.get_callees("func:MyClass.method1")
    assert len(callees) == 1
    assert callees[0]["id"] == "func:MyClass.method2"
```

#### 4. Dependencies ì¶”ê°€ ([pyproject.toml](../../pyproject.toml))

```toml
dependencies = [
    # ... existing deps ...
    "kuzu>=0.1.0",        # â† ì¶”ê°€
    "asyncpg>=0.29.0",    # â† ì¶”ê°€ (PostgresChunkStoreìš©)
    "openai>=1.0.0",      # â† ì¶”ê°€ (OpenAIEmbeddingProviderìš©)
]
```

---

## ğŸ¯ ì•„í‚¤í…ì²˜ ì—…ë°ì´íŠ¸

### Symbol Index Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GET /search/symbol?q=MyClass                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  IndexingService     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  KuzuSymbolIndex     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Kuzu Graph DB       â”‚
                    â”‚  (Symbol nodes +     â”‚
                    â”‚   Relationship edges)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    Cypher Query: MATCH (s:Symbol)
                    WHERE s.name CONTAINS 'MyClass'
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SearchHit           â”‚
                    â”‚  source="symbol"     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GraphDocument â†’ Kuzu ë³€í™˜

```
GraphDocument
  â”œâ”€â”€ graph_nodes: dict[str, GraphNode]
  â”‚   â”œâ”€â”€ id: "class:MyClass"
  â”‚   â”œâ”€â”€ kind: GraphNodeKind.CLASS
  â”‚   â”œâ”€â”€ fqn: "mymodule.MyClass"
  â”‚   â”œâ”€â”€ name: "MyClass"
  â”‚   â”œâ”€â”€ path: "mymodule.py"
  â”‚   â””â”€â”€ span: Span(start_line=10, end_line=50)
  â”‚
  â””â”€â”€ graph_edges: list[GraphEdge]
      â”œâ”€â”€ id: "edge:file_contains_class"
      â”œâ”€â”€ kind: GraphEdgeKind.CONTAINS
      â”œâ”€â”€ source_id: "file:mymodule.py"
      â””â”€â”€ target_id: "class:MyClass"

              â†“ Kuzu Adapter â†“

Kuzu Database
  â”œâ”€â”€ Symbol nodes
  â”‚   CREATE (s:Symbol {
  â”‚     id: "class:MyClass",
  â”‚     kind: "Class",
  â”‚     fqn: "mymodule.MyClass",
  â”‚     name: "MyClass",
  â”‚     path: "mymodule.py",
  â”‚     start_line: 10,
  â”‚     end_line: 50
  â”‚   })
  â”‚
  â””â”€â”€ Relationship edges
      CREATE (file)-[r:Relationship {
        kind: "CONTAINS"
      }]->(class)
```

---

## ğŸ“ ì—…ë°ì´íŠ¸ëœ íŒŒì¼ êµ¬ì¡°

```
src/
â”œâ”€â”€ ports.py                              # âœ… SymbolIndexPort (ì´ë¯¸ ì •ì˜ë¨)
â”œâ”€â”€ index/
â”‚   â”œâ”€â”€ __init__.py                       # âœ… Symbol exports ì¶”ê°€
â”‚   â”œâ”€â”€ factory.py                        # âœ… KuzuSymbolIndex í†µí•©
â”‚   â”œâ”€â”€ service.py                        # âœ… (ì´ë¯¸ ì™„ë£Œ)
â”‚   â”œâ”€â”€ symbol/
â”‚   â”‚   â”œâ”€â”€ __init__.py                   # âœ… ì˜¤ëŠ˜ ì‘ì„±!
â”‚   â”‚   â””â”€â”€ adapter_kuzu.py               # âœ… ì˜¤ëŠ˜ ì‘ì„±!
â”‚   â”œâ”€â”€ lexical/
â”‚   â”‚   â””â”€â”€ adapter_zoekt.py              # âœ… (ì´ë¯¸ ì™„ë£Œ)
â”‚   â””â”€â”€ vector/
â”‚       â””â”€â”€ adapter_qdrant.py             # âœ… (ì´ë¯¸ ì™„ë£Œ)
â””â”€â”€ foundation/
    â””â”€â”€ graph/
        â””â”€â”€ models.py                     # âœ… GraphDocument (ì´ë¯¸ ì™„ë£Œ)

tests/
â””â”€â”€ index/
    â””â”€â”€ test_symbol_index.py              # âœ… ì˜¤ëŠ˜ ì‘ì„±!

pyproject.toml                            # âœ… kuzu dependency ì¶”ê°€
```

---

## ğŸ”§ Symbol Index ì‚¬ìš© ì˜ˆì‹œ

### 1. ì¸ë±ì‹±

```python
from src.index import create_indexing_service
from src.foundation.graph.models import GraphDocument

# IndexingService ìƒì„± (Symbol Index í¬í•¨)
service = await create_indexing_service(
    chunk_store=chunk_store,
    enable_symbol=True,           # Symbol Index í™œì„±í™”
    kuzu_db_path="./kuzu_db",
)

# ì „ì²´ ì¸ë±ì‹±
service.index_repo_full(
    repo_id="myrepo",
    snapshot_id="commit123",
    chunks=chunks,
    graph_doc=graph_doc,          # GraphDocument ì œê³µ
)
```

### 2. ê²€ìƒ‰

```python
# ì‹¬ë³¼ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰
results = await service.symbol_index.search(
    repo_id="myrepo",
    snapshot_id="commit123",
    query="HybridRetriever",
    limit=50,
)

# ê²°ê³¼:
# [
#   SearchHit(
#     chunk_id="symbol:class:HybridRetriever",
#     file_path="src/search/hybrid.py",
#     symbol_id="class:HybridRetriever",
#     score=1.0,
#     source="symbol",
#     metadata={
#       "kind": "Class",
#       "fqn": "search.hybrid.HybridRetriever",
#       "name": "HybridRetriever",
#       "start_line": 15,
#       "end_line": 120,
#     }
#   )
# ]
```

### 3. Caller/Callee ë¶„ì„

```python
# Callers ì¡°íšŒ (ëˆ„ê°€ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ”ê°€?)
callers = service.symbol_index.get_callers("func:search.HybridRetriever.search")

# Callees ì¡°íšŒ (ì´ í•¨ìˆ˜ê°€ ë¬´ì—‡ì„ í˜¸ì¶œí•˜ëŠ”ê°€?)
callees = service.symbol_index.get_callees("func:search.HybridRetriever.search")
```

### 4. API ì‚¬ìš©

```bash
# Symbol ê²€ìƒ‰
curl "http://localhost:8000/search/symbol?q=HybridRetriever&repo_id=myrepo&limit=10"

# ì‘ë‹µ:
{
  "query": "HybridRetriever",
  "repo_id": "myrepo",
  "snapshot_id": "HEAD",
  "results": [
    {
      "chunk_id": "symbol:class:HybridRetriever",
      "file_path": "src/search/hybrid.py",
      "symbol_id": "class:HybridRetriever",
      "score": 1.0,
      "source": "symbol",
      "metadata": {
        "kind": "Class",
        "fqn": "search.hybrid.HybridRetriever",
        "name": "HybridRetriever",
        "start_line": 15,
        "end_line": 120
      }
    }
  ],
  "total": 1,
  "source": "symbol"
}
```

---

## ğŸ‰ ì£¼ìš” ì„±ê³¼

### 1. Production-Ready Symbol Index
- âœ… Kuzu embedded graph database ì‚¬ìš©
- âœ… GraphDocument ìë™ ë³€í™˜
- âœ… Snapshot ê²©ë¦¬ (ë²„ì „ ê´€ë¦¬)
- âœ… Caller/Callee ì¿¼ë¦¬ (í˜¸ì¶œ ê·¸ë˜í”„ ë¶„ì„)

### 2. í†µí•© ê²€ìƒ‰ ì§€ì›
- âœ… Unified searchì— Symbol í¬í•¨ (IndexingService)
- âœ… Weighted fusion (Lexical + Vector + Symbol)
- âœ… API ì—”ë“œí¬ì¸íŠ¸: `/search/symbol`

### 3. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
- âœ… 4ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- âœ… Snapshot ê²©ë¦¬ ê²€ì¦
- âœ… Caller/Callee ì¿¼ë¦¬ ê²€ì¦

---

## ğŸ“Š Index Layer ìµœì¢… ì™„ì„±ë„

### ì™„ë£Œëœ Index

| Index Type | Backend | Status | Features |
|------------|---------|--------|----------|
| **Lexical** | Zoekt | âœ… 100% | File-based text search, Hybrid chunk mapping |
| **Vector** | Qdrant | âœ… 100% | Semantic search, Batch embedding |
| **Symbol** | Kuzu | âœ… 100% | Graph-based navigation, Caller/Callee |
| Fuzzy | PostgreSQL | â³ 0% | Trigram fuzzy matching (Phase 3) |
| Domain | Qdrant | â³ 0% | Documentation search (Phase 3) |
| Runtime | TBD | â³ 0% | Hot path analysis (Phase 3) |

### ì™„ì„±ë„ ìš”ì•½

**Index Layer**: 99% (3/6 indexes ì™„ë£Œ)
- Lexical, Vector, Symbol: Production Ready
- Fuzzy, Domain, Runtime: Phase 3 (ì„ íƒ ì‚¬í•­)

**ì „ì²´ ì‹œìŠ¤í…œ**: 98%
- Foundation Layer: 100%
- RepoMap Layer: 100%
- Chunk Layer: 90%
- Index Layer: 99%

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒ)

### Option 1: ë‚¨ì€ Index êµ¬í˜„ (Fuzzy, Domain)
- **Fuzzy Index** (PostgreSQL pg_trgm)
  - ì˜ˆìƒ ì‹œê°„: 1-2ì‹œê°„
  - ì˜¤íƒ€/ë¶ˆì™„ì „í•œ ì¿¼ë¦¬ ì²˜ë¦¬

- **Domain Index** (Qdrant)
  - ì˜ˆìƒ ì‹œê°„: 1ì‹œê°„
  - README, ADR, ë¬¸ì„œ ê²€ìƒ‰

### Option 2: E2E í…ŒìŠ¤íŠ¸ ì‘ì„±
- Integration tests (2-3ì‹œê°„)
- Performance benchmarks
- API contract tests

### Option 3: Production ë°°í¬
- Docker Compose ì„¤ì •
- CI/CD íŒŒì´í”„ë¼ì¸
- Monitoring & Logging

---

## ğŸ’¡ Symbol Index í™œìš© ì‹œë‚˜ë¦¬ì˜¤

### 1. Code Navigation
```python
# Go-to-definition
symbol = await symbol_index.search("myrepo", "HEAD", "HybridRetriever")
# â†’ "src/search/hybrid.py:15-120"

# Find references (callers)
callers = symbol_index.get_callers("func:HybridRetriever.search")
# â†’ ["func:main.search_code", "func:api.search_endpoint"]
```

### 2. Call Graph Analysis
```python
# Who calls this function?
callers = symbol_index.get_callers("func:critical_function")

# What does this function call?
callees = symbol_index.get_callees("func:critical_function")

# Build full call chain
def get_call_chain(symbol_id, depth=3):
    chain = []
    for _ in range(depth):
        callees = symbol_index.get_callees(symbol_id)
        chain.extend(callees)
    return chain
```

### 3. Refactoring Support
```python
# Find all usages before renaming
usages = symbol_index.get_callers("func:old_function_name")

# Impact analysis
affected_symbols = []
for caller in usages:
    affected_symbols.extend(
        symbol_index.get_callers(caller["id"])
    )
```

---

## ğŸ“– ì°¸ì¡° ë¬¸ì„œ

- [06.êµ¬í˜„ì™„ë£Œ_2024-11-24.md](06.êµ¬í˜„ì™„ë£Œ_2024-11-24.md) - Index Layer ì „ì²´ êµ¬í˜„ ë³´ê³ ì„œ
- [src/foundation/graph/models.py](../../src/foundation/graph/models.py) - GraphDocument ëª¨ë¸
- [src/index/symbol/adapter_kuzu.py](../../src/index/symbol/adapter_kuzu.py) - Kuzu adapter êµ¬í˜„
- [tests/index/test_symbol_index.py](../../tests/index/test_symbol_index.py) - Symbol Index í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2024-11-24
**ì™„ì„±ë„**: 99%
**Status**: âœ… Production Ready (Lexical + Vector + Symbol)
