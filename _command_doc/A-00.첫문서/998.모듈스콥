1. CodeGraph Engine
1.1 Parsing & AST (Phase 1)

구성요소

Tree-sitter Registry

Normalized AST

AST Traversal API

Position Mapper

Language Tier (T1/T2/T3)

핵심 규칙

모든 파서는 Normalized AST로 변환

byte offset → UTF16 position 보존

Tier-1 언어(Python/TS/Go/Java)는 CFG/DFG까지 필수

1.2 IR Layer (Phase 2)

구성요소

IRNode(File/Class/Function/Var/Import)

IRType(builtin/local/generic)

IRSignature(parameters/return/decorator hash)

Basic Edges: IMPORTS / CONTAINS / CALLS

핵심 규칙

모든 IRNode는 FQN + content_hash 기반 안정 ID

시그니처 hash는 rename 탐지의 기준

1.3 Control & Data Flow (Phase 3–4)

구성요소

BFG (Basic Block Graph)

CFG Edges (seq / branch / loop / exception / return)

DFG Edges (read/write)

SSA / Taint Hooks

핵심 규칙

CFG/DFG는 Graph Layer의 심층 이해의 기반

SSA는 optional이지만 rename detection precision 상승

1.4 Graph Construction (Phase 5)

구성요소

GraphNode(Symbol/Type/Signature/CFG/DFG)

GraphEdge(12종: CONTAINS/CALLS/READS/WRITES/INHERITS/…)

Graph Normalizer

Neighbor Map(빠른 k-hop)

핵심 규칙

GraphNode는 IR/CFG/DFG 합성 뷰

Edge dedupe: (src, dst, edge_type) 기준

1.5 Chunk Layer (Phase 6)

구성요소

6단 계층(Repo → Module → File → Class → Function → Block)

Stable Chunk ID

IR/Graph ↔ Chunk 매핑

Incremental Chunking

Span Drift Tracker

Rename Detector

핵심 규칙

변경범위 기반 incremental

span drift threshold ≤ 20 lines

block chunk는 50–100 lines

1.6 RepoMap Layer (Phase 7)

구성요소

RepoMapNode Tree

PageRank / HybridRank

Summary Generator

Tree/Context API

핵심 규칙

RepoMap은 LLM의 “전체 구조 이해용” 상위 지도

HybridRank = pagerank × recency × edit_freq × coverage

1.7 Multi-Index Layer (Phase 8)

인덱스 종류

Lexical (Zoekt/Meilisearch)

Vector (Qdrant)

Symbol Index

Fuzzy Index

Domain Meta Index (ADR/API Spec)

Runtime Index (Traces/Hot path)

핵심 규칙

Query는 모든 인덱스를 병렬 호출

Snapshot-consistent 검색 보장

2. Retrieval & Context System
2.1 Intent Router

의도 분류

NAVIGATE / SEARCH / UNDERSTAND / FIX / GENERATE

전략 매핑

intent → {index weights, graph depth, rerank 필요여부}

2.2 Multi-Index Fusion & Rerank

구성요소

Parallel Query

Score Normalization

RRF Fusion

Cross-Encoder Reranker

Graph Expansion(k-hop)

핵심 규칙

RRF로 coarse fusion → Cross-Encoder로 final rank

graph expansion은 depth≤2 기본

2.3 Context Builder

기능

Token Budget Allocation

Priority Scoring

Truncation Engine

Multi-turn Carry-over

Overflow Handling

핵심 규칙

retrieved_code 50%, graph 15%, history 15%

signature는 항상 보존, body는 semantic chunk로 자름

2.4 Advanced Context Layer

구성요소

Semantic Subgraph

Change Impact (CFG/DFG 기반)

Runtime Evidence (trace/hot path)

Architecture Constraints

Coverage-aware Selection

3. Agent System
3.1 Tool Layer

도구
open_file / code_search / symbol_search / graph_neighbors / propose_patch / apply_patch / syntax_check / type_check / lint_run / run_tests / git_commit / git_reset

Pre/Postcondition 명시
예: apply_patch → syntax_check.pass 필요

3.2 Planner

구성요소

Plan Schema (DAG)

Task Decomposition

Plan Validator

Plan Visualizer

3.3 Orchestration (LangGraph)

흐름
Planner → Tool Router → Executor → Reviewer → Reflection → (Replan)

3.4 Human-in-the-Loop

Approval / Reject / Partial Accept / Override / Explain 요청

3.5 Reflection & Self-Correction

Failure Classifier / Root-Cause / Correction Planner / Retry Strategy / History Tracker

4. Intelligence Layer
4.1 Diagnostics & LSP

syntax check / type check(pyright/mypy/tsc) / LSP hover, definition, diagnostics

4.2 Architecture Rule Engine

layer rule / domain boundary / violation detector / pattern recommendation

4.3 Proactive Quality Scanner

anti-pattern / performance / security / coverage gap / priority ranker

4.4 Decision Memory

patch vector store / success pattern mining / similar case retrieval / org preference learner

4.5 Explainable Decision Engine

rationale / evidence / alternatives / tradeoff / uncertainty

5. Cross-Cutting Systems

(v3.2에서 가장 크게 확장된 부분)

5.1 Incremental Execution

changed file → incremental parsing → incremental IR/Graph → index selective update

5.2 Evaluation & Benchmark

SWE-Bench / HumanEval / regression suite / pass@1 / delta metric

5.3 Observability & Telemetry (신규 강화)

Distributed Tracing(LLM Call, Tool Call, Retrieval Flow)

Structured Logging(JSON, correlation_id)

Metrics(Prometheus/Otel)

Dashboard(Grafana)

Alerts(latency spike, resolve-rate drop)

5.4 Concurrency & Scheduling (신규 모듈)

Tool parallel execution (dependency-free steps)

Multi-Index parallel query with timeout

Circuit breaker(per index backend)

Worker pool 기반 parallel parsing/indexing

Rate limiting(LLM/LSP/Index)

5.5 Caching & Invalidation (신규 모듈)

LLM Response Cache

Embedding Cache

Tool Result Cache

Graph Query Cache

Snapshot-based invalidation

File-change fine-grain invalidation

5.6 Resilience & Degradation (신규 모듈)

LLM fallback(primary→backup→cache)

Index partial failure 허용

Degraded retrieval mode

Checkpoint & Resume

Tool timeout recovery

5.7 Versioning & Migration (신규 모듈)

schema_version for IR/Graph/Index

dual-read / dual-write migration

online migration with shadow compare

rollback 정책

offline rebuild 모드(degrade to lexi)

5.8 Multi-Repo & Monorepo Support (신규 모듈)

repo_id 포함한 Graph/Index key

cross-repo edges

project boundary (RepoMap)

repo/visibility permission filter

monorepo: project-scoped retrieval

5.9 Prompt Management Layer (신규 모듈)

Prompt Template Registry

Prompt Versioning / A/B test

Dynamic Prompt Composition

Prompt Performance Metrics(success rate / retry / hallucination)

6. Operational Layers (Security / Sandboxing)
6.1 Security Policy Engine

tool permission

file access allowlist

command execution policy

6.2 Sandboxed Execution

Docker/Firecracker/gVisor

no outbound network by default

secret scanning

audit logging(who/what/when/diff)