# Nextest Configuration for codegraph-ir
# This file configures test execution, timing tracking, and profiles
#
# Usage:
#   cargo nextest run                    # default profile
#   cargo nextest run --profile fast     # fast unit tests only
#   cargo nextest run --profile ci       # CI with timing report

[store]
# Enable test timing storage for tracking slow tests
dir = "target/nextest"

# ============================================================================
# Default Profile - Daily Development
# ============================================================================
[profile.default]
# Parallel execution settings (auto-detect CPU cores)
test-threads = "num-cpus"

# Retry flaky tests once
retries = 1

# Fail fast on first failure (for quick feedback)
fail-fast = true

# Timeout for individual tests (30s should cover most)
slow-timeout = { period = "30s", terminate-after = 2 }

# Status level
status-level = "pass"

# Final status output
final-status-level = "slow"

# Store timing data
archive.include = ["nextest"]

# ============================================================================
# Fast Profile - TDD / Quick iteration
# ============================================================================
[profile.fast]
# Filter to only unit tests (no integration/e2e)
default-filter = "test(/unit/) | not test(/integration|e2e|stress|performance|benchmark/)"

test-threads = "num-cpus"
fail-fast = true
slow-timeout = { period = "10s", terminate-after = 1 }

# ============================================================================
# CI Profile - Full test with timing report
# ============================================================================
[profile.ci]
test-threads = "num-cpus"
retries = 2
fail-fast = false

# Longer timeout for CI
slow-timeout = { period = "60s", terminate-after = 3 }

# Store test timing for CI reports
junit.path = "target/nextest/junit.xml"

# Show slow tests prominently
final-status-level = "slow"

# ============================================================================
# Slow Profile - Include ignored/slow tests
# ============================================================================
[profile.slow]
test-threads = "num-cpus"
retries = 0
fail-fast = false

# Very long timeout for benchmarks
slow-timeout = { period = "300s", terminate-after = 2 }
