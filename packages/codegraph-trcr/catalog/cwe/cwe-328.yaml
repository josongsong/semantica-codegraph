# CWE-328: Reversible One-Way Hash (Weak Hash)
#
# Contract-first CWE definition
# Reference: https://cwe.mitre.org/data/definitions/328.html

metadata:
  cwe_id: CWE-328
  name: "Use of Weak Hash"
  severity: high
  owasp: "A02:2021-Cryptographic Failures"
  category: "Cryptography"
  status: active
  version: "1.0.0"
  last_updated: "2025-12-18"
  mitre_abstraction: variant
  likelihood_of_exploit: high
  references:
    - https://cwe.mitre.org/data/definitions/328.html
    - https://owasp.org/www-community/vulnerabilities/Insufficient_Password_Hash

description: |
  The product uses a one-way cryptographic hash against an input that should
  not be reversible, such as a password, but uses a weak hash algorithm that
  makes it easier to determine the original input.

sources:
  - id: source.password
    description: "Password or sensitive data to hash"
    patterns:
      - variable: password
      - variable: secret
      - variable: api_key

sinks:
  - id: sink.crypto.weak_hash
    description: "Weak hash algorithms"
    patterns:
      - call: hashlib.md5
      - call: hashlib.sha1
      - call: Crypto.Hash.MD5.new
      - call: Crypto.Hash.SHA.new

sanitizers:
  - id: barrier.crypto.strong_hash
    description: "Strong hash algorithms"
    patterns:
      - call: hashlib.sha256
      - call: hashlib.sha512
      - call: hashlib.blake2b
      - call: bcrypt.hashpw
      - call: argon2.hash

policy:
  grammar:
    WHEN:
      tag: sensitive_data
    FLOWS:
      - id: sink.crypto.weak_hash
    BLOCK:
      UNLESS:
        kind: sanitizer
        tag: strong_crypto

validation:
  min_test_cases: 6
  min_precision: 0.90
  min_recall: 0.85

test_suite:
  juliet:
    directory: "test-suite/CWE328_Weak_Hash"
    cases:
      - bad_01.py
      - bad_02.py
      - good_01.py
      - good_02.py

examples:
  vulnerable:
    - |
      # BAD: MD5 for password
      password_hash = hashlib.md5(password.encode()).hexdigest()

  safe:
    - |
      # GOOD: bcrypt for password
      password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt())

fix:
  priority: 1
  effort: low
  recommendations:
    - title: "Use bcrypt or argon2 for passwords"
      severity: best
      example: |
        import bcrypt
        hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt())
